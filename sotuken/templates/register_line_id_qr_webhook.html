<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LINE ID ç™»éŒ² | ShiftForm</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/register_line_id.css') }}">
</head>
<body>
  <div class="container">
    <h1>ğŸ”— LINE ID ç™»éŒ²</h1>
    <p class="subtitle">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ LINE ã«ç™»éŒ²</p>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="message-alert" class="alert" style="display: none;"></div>

    <div class="content">
      <!-- QRã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="qr-section">
        <h2>1ï¸âƒ£ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€</h2>
        <div class="qr-code">
          <img src="{{ qr_code_url }}" alt="LINE QR Code">
        </div>
        <div class="qr-instructions">
          <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ä¸Šã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã€</p>
          <p>å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹é”è¿½åŠ ã—ã¾ã™ã€‚</p>
        </div>
      </div>

      <!-- åŒºåˆ‡ã‚Šç·š -->
      <div class="divider">|</div>

      <!-- çŠ¶æ…‹è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <h2>2ï¸âƒ£ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡</h2>

        <div class="status-box">
          <div class="status-icon" id="status-icon">â³</div>
          <div class="status-text waiting" id="status-text">
            ç™»éŒ²ä¸­...
          </div>
          <div class="status-text" id="status-hint">
            å‹é”è¿½åŠ å¾Œã€ä½•ã‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã ã•ã„
          </div>
        </div>

        <button type="button" id="start-btn" onclick="startRegistration()">
          ç™»éŒ²é–‹å§‹
        </button>
        <button type="button" class="btn-secondary" onclick="goHome()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <span>ç™»éŒ²ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</span>
        </div>
      </div>
    </div>

    <div class="skip-link">
      <a href="javascript:goHome()">å¾Œã§ç™»éŒ²ã™ã‚‹ â†’</a>
    </div>
  </div>

  <script>
    let registrationInProgress = false;
    let pollInterval = null;

    async function startRegistration() {
      if (registrationInProgress) return;

      const startBtn = document.getElementById('start-btn');
      const loadingDiv = document.getElementById('loading');
      const messageAlert = document.getElementById('message-alert');

      registrationInProgress = true;
      startBtn.disabled = true;
      loadingDiv.style.display = 'block';

      try {
        const response = await fetch('{{ url_for("line.start_line_id_registration") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('âœ… ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚å…¬å¼LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã ã•ã„ã€‚', 'info');
          startPolling();
        } else {
          showMessage(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          startBtn.disabled = false;
          registrationInProgress = false;
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        startBtn.disabled = false;
        registrationInProgress = false;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    function startPolling() {
      const maxAttempts = 20;
      let attempts = 0;

      pollInterval = setInterval(() => {
        attempts++;

        if (attempts > maxAttempts) {
          clearInterval(pollInterval);
          showMessage('â±ï¸ ç™»éŒ²æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'error');
          registrationInProgress = false;
          document.getElementById('start-btn').disabled = false;
          return;
        }

        checkRegistrationStatus();
      }, 30000);
    }

    async function checkRegistrationStatus() {
      try {
        const response = await fetch('{{ url_for("line.check_line_id_registration") }}', {
          method: 'GET'
        });

        const data = await response.json();

        if (data.registered) {
          clearInterval(pollInterval);
          updateStatusBox(true);
          showMessage('âœ… LINE ID ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
          
          setTimeout(() => {
            goHome();
          }, 2000);
        }
      } catch (error) {
        console.error('Error checking status:', error);
      }
    }

    function updateStatusBox(registered) {
      const icon = document.getElementById('status-icon');
      const text = document.getElementById('status-text');
      const hint = document.getElementById('status-hint');

      if (registered) {
        icon.textContent = 'âœ…';
        text.textContent = 'ç™»éŒ²å®Œäº†ï¼';
        text.classList.remove('waiting');
        text.classList.add('registered');
        hint.textContent = 'ãƒ›ãƒ¼ãƒ ç”»é¢ã«é·ç§»ã—ã¾ã™...';
      }
    }

    function showMessage(message, type) {
      const messageAlert = document.getElementById('message-alert');
      messageAlert.textContent = message;
      messageAlert.className = `alert alert-${type}`;
      messageAlert.style.display = 'block';
    }

    function goHome() {
      if (pollInterval) clearInterval(pollInterval);
      const homeUrl = '{{ url_for("login.staff_home") if session.get("role") == "staff" else url_for("login.manager_home") }}';
      window.location.href = homeUrl;
    }
  </script>
</body>
</html>