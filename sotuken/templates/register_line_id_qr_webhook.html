<!-- ========================================
     register_line_id_qr_webhook.html
     Webhookå¯¾å¿œç‰ˆã®QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºç”»é¢
     ======================================== -->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE ID ç™»éŒ² | ShiftForm</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 600px) {
      .content {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .qr-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .qr-section h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .qr-code {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }

    .qr-code img {
      width: 200px;
      height: 200px;
      display: block;
    }

    .qr-instructions {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 15px;
      line-height: 1.6;
    }

    .divider {
      text-align: center;
      color: #ccc;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 600px) {
      .divider {
        display: none;
      }
    }

    .form-section {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .form-section h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 20px;
    }

    .status-box {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .status-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .status-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .status-text.waiting {
      color: #667eea;
      font-weight: bold;
    }

    .status-text.registered {
      color: #28a745;
      font-weight: bold;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 10px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #ccc;
    }

    .alert {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading {
      display: none;
      text-align: center;
      color: #667eea;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .skip-link {
      text-align: center;
      margin-top: 20px;
    }

    .skip-link a {
      color: #999;
      text-decoration: none;
      font-size: 14px;
    }

    .skip-link a:hover {
      color: #666;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”— LINE ID ç™»éŒ²</h1>
    <p class="subtitle">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ LINE ã«ç™»éŒ²</p>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="message-alert" class="alert" style="display: none;"></div>

    <div class="content">
      <!-- QRã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="qr-section">
        <h2>1ï¸âƒ£ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€</h2>
        <div class="qr-code">
          <img src="{{ qr_code_url }}" alt="LINE QR Code">
        </div>
        <div class="qr-instructions">
          <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ä¸Šã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã€</p>
          <p>å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹é”è¿½åŠ ã—ã¾ã™ã€‚</p>
        </div>
      </div>

      <!-- åŒºåˆ‡ã‚Šç·š -->
      <div class="divider">|</div>

      <!-- çŠ¶æ…‹è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="form-section">
        <h2>2ï¸âƒ£ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡</h2>

        <div class="status-box">
          <div class="status-icon" id="status-icon">â³</div>
          <div class="status-text waiting" id="status-text">
            ç™»éŒ²ä¸­...
          </div>
          <div class="status-text" id="status-hint">
            å‹é”è¿½åŠ å¾Œã€ä½•ã‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã ã•ã„
          </div>
        </div>

        <button type="button" id="start-btn" onclick="startRegistration()">
          ç™»éŒ²é–‹å§‹
        </button>
        <button type="button" class="btn-secondary" onclick="goHome()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <span>ç™»éŒ²ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</span>
        </div>
      </div>
    </div>

    <div class="skip-link">
      <a href="javascript:goHome()">å¾Œã§ç™»éŒ²ã™ã‚‹ â†’</a>
    </div>
  </div>

  <script>
    let registrationInProgress = false;
    let pollInterval = null;

    async function startRegistration() {
      if (registrationInProgress) return;

      const startBtn = document.getElementById('start-btn');
      const loadingDiv = document.getElementById('loading');
      const messageAlert = document.getElementById('message-alert');

      registrationInProgress = true;
      startBtn.disabled = true;
      loadingDiv.style.display = 'block';

      try {
        const response = await fetch('{{ url_for("line.start_line_id_registration") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('âœ… ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚å…¬å¼LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã ã•ã„ã€‚', 'info');
          startPolling();
        } else {
          showMessage(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          startBtn.disabled = false;
          registrationInProgress = false;
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        startBtn.disabled = false;
        registrationInProgress = false;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    function startPolling() {
      // å®šæœŸçš„ã«ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªï¼ˆ30ç§’ã”ã¨ã€æœ€å¤§10åˆ†ï¼‰
      const maxAttempts = 20; // 10åˆ† / 30ç§’ = 20å›
      let attempts = 0;

      pollInterval = setInterval(() => {
        attempts++;

        if (attempts > maxAttempts) {
          clearInterval(pollInterval);
          showMessage('â±ï¸ ç™»éŒ²æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'error');
          registrationInProgress = false;
          document.getElementById('start-btn').disabled = false;
          return;
        }

        // ç™»éŒ²å®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯
        checkRegistrationStatus();
      }, 30000); // 30ç§’ã”ã¨
    }

    async function checkRegistrationStatus() {
      try {
        const response = await fetch('{{ url_for("line.check_line_id_registration") }}', {
          method: 'GET'
        });

        const data = await response.json();

        if (data.registered) {
          clearInterval(pollInterval);
          updateStatusBox(true);
          showMessage('âœ… LINE ID ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
          
          setTimeout(() => {
            goHome();
          }, 2000);
        }
      } catch (error) {
        console.error('Error checking status:', error);
      }
    }

    function updateStatusBox(registered) {
      const icon = document.getElementById('status-icon');
      const text = document.getElementById('status-text');
      const hint = document.getElementById('status-hint');

      if (registered) {
        icon.textContent = 'âœ…';
        text.textContent = 'ç™»éŒ²å®Œäº†ï¼';
        text.classList.remove('waiting');
        text.classList.add('registered');
        hint.textContent = 'ãƒ›ãƒ¼ãƒ ç”»é¢ã«é·ç§»ã—ã¾ã™...';
      }
    }

    function showMessage(message, type) {
      const messageAlert = document.getElementById('message-alert');
      messageAlert.textContent = message;
      messageAlert.className = `alert alert-${type}`;
      messageAlert.style.display = 'block';
    }

    function goHome() {
      if (pollInterval) clearInterval(pollInterval);
      const homeUrl = '{{ url_for("login.staff_home") if session.get("role") == "staff" else url_for("login.manager_home") }}';
      window.location.href = homeUrl;
    }
  </script>
</body>
</html>