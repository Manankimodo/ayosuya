<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='auto_calendar.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

</head>
<body>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>

  {% if settings %}
  <div class="settings-box">
    <h3>ğŸ›  ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>ä¼‘æ†©æ™‚é–“: {{ settings.break_minutes }}åˆ†</li>
      <li>ã‚·ãƒ•ãƒˆé–“éš”: {{ settings.interval_minutes }}åˆ†</li>
      <li>æœ€å¤§å‹¤å‹™æ™‚é–“: {{ settings.max_hours_per_day }}æ™‚é–“</li>
      <li>æœ€å°å‹¤å‹™æ™‚é–“: {{ settings.min_hours_per_day }}æ™‚é–“</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
      <li>ãƒ¢ãƒ¼ãƒ‰: {{ settings.auto_mode }}</li>
    </ul>
  </div>
  {% endif %}

  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}

  {% if shifts %}
    <div id="charts"></div> <!-- ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒªã‚¢ -->
  {% else %}
    <p>ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

  <!-- ğŸ¯ ã“ã“ã‚’è¿½åŠ ï¼šãƒœã‚¿ãƒ³ç¾¤ -->
  <div class="button-group">
    <!-- âœ… å†ç·¨é›†ãƒœã‚¿ãƒ³ -->
  <a href="{{ url_for('makeshift.auto_calendar') }}" class="btn secondary">â™»ï¸ å†ç·¨é›†ï¼ˆå†ç”Ÿæˆï¼‰</a>
  </div>
  <div class="back">
    <button class="btn secondary" onclick="location.href='/makeshift/admin'">ğŸ”™ æˆ»ã‚‹</button>
  </div>

  <script>
    const shiftData = JSON.parse('{{ shifts|tojson|safe }}');
    const validData = shiftData.filter(s => s.start_time && s.end_time);

    if (validData.length === 0) {
      document.getElementById("charts").innerHTML = "<p>æœ‰åŠ¹ãªã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    } else {
      const groupedByDateAndUser = {};
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ã•ã‚‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«ãƒãƒ¼ã‚¸ã™ã‚‹
      validData.forEach(s => {
        const date = s.date;
        const userId = s.user_id;
        
        if (!groupedByDateAndUser[date]) groupedByDateAndUser[date] = {};
        if (!groupedByDateAndUser[date][userId]) groupedByDateAndUser[date][userId] = [];
        
        groupedByDateAndUser[date][userId].push(s);
      });

      const chartsDiv = document.getElementById("charts");
      
      // æç”»ç”¨ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
      const colors = {};
      let colorIndex = 0;
      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];

      Object.entries(groupedByDateAndUser).forEach(([date, userShifts], idx) => {
        const container = document.createElement("div");
        container.classList.add("chart-container");
        container.innerHTML = `<h2>${date}</h2><canvas id="chart_${idx}"></canvas>`;
        chartsDiv.appendChild(container);

        const ctx = document.getElementById(`chart_${idx}`).getContext("2d");
        
        const datasets = [];
        const yAxisLabels = []; // Yè»¸ã®ãƒ©ãƒ™ãƒ«é †åºã‚’ä¿æŒ

        Object.entries(userShifts).forEach(([userId, shifts], i) => {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«è‰²ã‚’å‰²ã‚Šå½“ã¦
          if (!colors[userId]) {
            colors[userId] = baseColors[colorIndex % baseColors.length];
            colorIndex++;
          }
          const userColor = colors[userId];
          
          // Yè»¸ã®ãƒ©ãƒ™ãƒ«ãƒªã‚¹ãƒˆã«è¿½åŠ 
          if (!yAxisLabels.includes(userId)) {
              yAxisLabels.push(userId);
          }

          shifts.forEach((s) => {
            // Xè»¸ã‚’æ­£ã—ãæ™‚é–“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
            const start = new Date(`1970-01-01T${s.start_time}:00`);
            const end = new Date(`1970-01-01T${s.end_time}:00`);
            const isBreak = s.type === "break";
            
            const dataPoint = {
              x: [start, end], 
              y: userId // Yè»¸ã®å€¤ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæ–‡å­—åˆ—ã®ã¾ã¾
            };

            datasets.push({
              label: isBreak ? `${userId}ï¼ˆä¼‘æ†©ï¼‰` : userId,
              data: [dataPoint],
              backgroundColor: isBreak ? "rgba(255, 180, 80, 0.9)" : userColor,
              borderColor: isBreak ? "rgba(0,0,0,0.2)" : "rgba(0,0,0,0.2)",
              borderWidth: 1,
              userLabel: userId, 
              breakFlag: isBreak
            });
          });
        });

        // Chart.jsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        new Chart(ctx, {
          type: "bar",
          data: { datasets },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: {
                // Xè»¸ã‚’ã€Œæ™‚é–“(time)ã€ã‚¿ã‚¤ãƒ—ã«è¨­å®š
                type: "time",
                time: { 
                    unit: "hour", 
                    displayFormats: { hour: "HH:mm" } 
                },
                min: new Date("1970-01-01T08:00:00"), 
                max: new Date("1970-01-01T19:00:00"), 
                title: { display: true, text: "å‹¤å‹™æ™‚é–“" }
              },
              y: { 
                // Yè»¸ã‚’ã€Œcategoryã€ã‚¿ã‚¤ãƒ—ã«è¨­å®šã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚«ãƒ†ã‚´ãƒªå‡¦ç†ã«ä»»ã›ã‚‹
                type: 'category', 
                labels: yAxisLabels, // ãƒ©ãƒ™ãƒ«ã¯æ˜ç¤ºçš„ã«æ¸¡ã™ãŒã€è¤‡é›‘ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ä½¿ç”¨ã—ãªã„
                grid: { display: true },
                title: { display: true, text: "ã‚¹ã‚¿ãƒƒãƒ•" } 
              }
            },
            plugins: {
              legend: { display: false }, 
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const start = new Date(ctx.raw.x[0]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    const end = new Date(ctx.raw.x[1]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    const type = ctx.dataset.breakFlag ? "ä¼‘æ†©" : "å‹¤å‹™";
                    return `${ctx.dataset.userLabel} (${type}): ${start}ã€œ${end}`;
                  }
                }
              }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
