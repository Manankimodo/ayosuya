<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='auto_calendar.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    .chart-container {
      width: 90%;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>

  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}

  {% if shifts %}
    <div id="charts"></div> <!-- ã‚°ãƒ©ãƒ•ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
  {% else %}
    <p>ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

  <script>
    // âœ… Flaskã‹ã‚‰å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿
    const shiftData = JSON.parse('{{ shifts|tojson|safe }}');
    console.log("âœ… shiftData:", shiftData);

    // ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ãŒnullï¼‰ã‚’é™¤å¤–
    const validData = shiftData.filter(s => s.start_time && s.end_time);

    if (validData.length === 0) {
      document.getElementById("charts").innerHTML = "<p>æœ‰åŠ¹ãªã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    } else {
      // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      validData.forEach(s => {
        if (!grouped[s.date]) grouped[s.date] = [];
        grouped[s.date].push(s);
      });

      const chartsDiv = document.getElementById("charts");

      // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
      Object.entries(grouped).forEach(([date, items], idx) => {
        // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
        const container = document.createElement("div");
        container.classList.add("chart-container");
        container.innerHTML = `<h2>${date}</h2><canvas id="chart_${idx}"></canvas>`;
        chartsDiv.appendChild(container);

        const ctx = document.getElementById(`chart_${idx}`).getContext("2d");

        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æ§‹ç¯‰
        const datasets = items.map((s, i) => {
          const start = new Date(`1970-01-01T${s.start_time}:00`);
          const end = new Date(`1970-01-01T${s.end_time}:00`);
          return {
            label: s.user_id,
            data: [{ x: [start, end], y: s.user_id }],
            backgroundColor: `hsl(${i * 70 % 360}, 70%, 60%)`
          };
        });

        // ã‚°ãƒ©ãƒ•æç”»
        new Chart(ctx, {
          type: "bar",
          data: { datasets },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "hour",
                  displayFormats: { hour: "HH:mm" }
                },
                min: new Date("1970-01-01T00:00:00"),
                max: new Date("1970-01-01T23:59:00"),
                title: { display: true, text: "å‹¤å‹™æ™‚é–“" }
              },
              y: { title: { display: true, text: "ã‚¹ã‚¿ãƒƒãƒ•" } }
            },
            plugins: {
              legend: { display: true, position: "bottom" },
              tooltip: {
                callbacks: {
                  label: ctx =>
                    `${ctx.dataset.label}: ${ctx.raw.x[0].toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}ã€œ${ctx.raw.x[1].toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`
                }
              }
            }
          }
        });
      });
    }
  </script>

  <div class="back">
    <button onclick="location.href='/makeshift/admin'">ğŸ”™ æˆ»ã‚‹</button>
  </div>
</body>
</html>
