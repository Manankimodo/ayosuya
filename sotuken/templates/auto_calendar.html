<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auto_calendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/hamburger.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
 
  <script>
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSå¤‰æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
    window.flaskData = {
      shifts: JSON.parse('{{ shifts|tojson|safe }}') || [],
      settings: JSON.parse('{{ settings|tojson|safe }}') || {}
    };
    
    // â˜…â˜…â˜… ä¿®æ­£: ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ã™ã‚‹é…åˆ— â˜…â˜…â˜…
    window.chartInstances = {};
  </script>
 
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // 1. ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
      const menuIcon = document.getElementById('menuIcon');
      const sideMenu = document.getElementById('sideMenu');
      const closeBtn = document.getElementById('closeBtn');
      
      if (menuIcon && sideMenu) {
          menuIcon.addEventListener('click', function() {
              sideMenu.classList.add('active');
          });
      }
      
      if (closeBtn && sideMenu) {
          closeBtn.addEventListener('click', function() {
              sideMenu.classList.remove('active');
          });
      }
      
      if (sideMenu) {
          sideMenu.querySelectorAll('a').forEach(link => {
              link.addEventListener('click', function() {
                  sideMenu.classList.remove('active');
              });
          });
      }

      // ========================================================
      // 2. å…¬é–‹ãƒ»éå…¬é–‹åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
      // ========================================================
      window.publishShift = async function(month, status) {
          const action = status === 1 ? "å…¬é–‹" : "éå…¬é–‹";
          if (!confirm(`${month} åˆ†ã®ã‚·ãƒ•ãƒˆã‚’ ${action} ã«ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

          try {
              const response = await fetch("/makeshift/api/publish_status", {
                  method: 'POST',
                  headers: { 
                      'Content-Type': 'application/json',
                      'X-Requested-With': 'XMLHttpRequest'
                  },
                  body: JSON.stringify({ month: month, status: status })
              });
              const result = await response.json();

              if (result.success) {
                  alert(`âœ… ${result.message}`);
                  location.reload();
              } else {
                  alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.message}`);
              }
          } catch (error) {
              console.error('API Error:', error);
              alert('é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          }
      };

      // ========================================================
      // â˜…â˜…â˜… ä¿®æ­£: ãƒ­ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆé–¢æ•° â˜…â˜…â˜…
      // ========================================================
      window.toggleLock = async function(userId, date, startTime, endTime, chartId) {
          if (!userId || parseInt(userId) < 0) {
              showToast("âš ï¸ ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒƒã‚¯ã§ãã¾ã›ã‚“");
              return;
          }

          try {
              const response = await fetch('/makeshift/toggle_lock', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                      user_id: userId, 
                      date: date,
                      start_time: startTime,
                      end_time: endTime
                  })
              });
              const result = await response.json();
              
              if (result.status === 'success') {
                  // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                  window.flaskData.shifts.forEach(s => {
                      if (s.user_id == userId && s.date == date && 
                          s.start_time == startTime && s.end_time == endTime) {
                          s.is_locked = result.new_state;
                      }
                  });
                  
                  // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                  const chart = window.chartInstances[chartId];
                  if (chart) {
                      chart.data.datasets[0].data.forEach(d => {
                          if (d.original_user_id == userId && d.date == date &&
                              d.x[0].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) == startTime &&
                              d.x[1].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) == endTime) {
                              d.is_locked = result.new_state;
                          }
                      });
                      chart.update();
                  }
                  
                  showToast(result.new_state === 1 ? "ğŸ”’ ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ" : "ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ");
              } else {
                  alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
              }
          } catch (e) {
              console.error(e);
              alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          }
      };

      function showToast(msg) {
          const toast = document.createElement("div");
          toast.innerText = msg;
          toast.style.position = "fixed";
          toast.style.bottom = "20px";
          toast.style.right = "20px";
          toast.style.background = "rgba(0,0,0,0.8)";
          toast.style.color = "#fff";
          toast.style.padding = "10px 20px";
          toast.style.borderRadius = "5px";
          toast.style.zIndex = "9999";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
      }

      // ========================================================
      // 4. ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯
      // ========================================================
      const rawData = window.flaskData.shifts;
      const settings = window.flaskData.settings;
      const chartsDiv = document.getElementById("charts");
      
      // â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°: åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª â˜…â˜…â˜…
      console.log('rawDataç·æ•°:', rawData.length);
      console.log('rawDataä¸è¶³ãƒ‡ãƒ¼ã‚¿æ•°:', rawData.filter(s => parseInt(s.user_id) < 0).length);
      console.log('rawDataä¸è¶³ãƒ‡ãƒ¼ã‚¿ä¸€è¦§:', rawData.filter(s => parseInt(s.user_id) < 0));
      
      if (!rawData || rawData.length === 0 || !chartsDiv) {
          if(chartsDiv) chartsDiv.innerHTML = '<p style="text-align:center; padding:20px;">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
      }

      rawData.sort((a, b) => {
        const idA = parseInt(a.user_id);
        const idB = parseInt(b.user_id);
        const isStaffA = idA > 0;
        const isStaffB = idB > 0;
        
        if (isStaffA && !isStaffB) return -1;
        if (!isStaffA && isStaffB) return 1;
        if (a.start_time !== b.start_time) return a.start_time.localeCompare(b.start_time);
        if (a.end_time !== b.end_time) return a.end_time.localeCompare(b.end_time);
        return idA - idB;
      });

      const mergedShifts = [];
      if (rawData.length > 0) {
          let current = { ...rawData[0] };
          for (let i = 1; i < rawData.length; i++) {
              const next = rawData[i];
              
              // â˜…â˜…â˜… ä¿®æ­£: ä¸è¶³ãƒ‡ãƒ¼ã‚¿ï¼ˆè² ã®user_idï¼‰ã¯çµ¶å¯¾ã«ãƒãƒ¼ã‚¸ã—ãªã„ â˜…â˜…â˜…
              const shouldMerge = (
                  parseInt(current.user_id) > 0 &&  // é€šå¸¸ã®ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ãƒãƒ¼ã‚¸
                  current.user_id === next.user_id &&
                  current.date === next.date &&
                  current.type === next.type &&
                  (current.is_locked || 0) === (next.is_locked || 0) &&
                  current.end_time === next.start_time
              );
              
              // â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°: ãƒãƒ¼ã‚¸åˆ¤å®šã®è©³ç´°ã‚’å‡ºåŠ› â˜…â˜…â˜…
              if (parseInt(current.user_id) < 0 || parseInt(next.user_id) < 0) {
                  console.log(`ä¸è¶³ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯: current=${current.user_id}(${current.type}), next=${next.user_id}(${next.type}), shouldMerge=${shouldMerge}`);
              }
              
              if (shouldMerge) {
                  current.end_time = next.end_time;
              } else {
                  mergedShifts.push(current);
                  current = { ...next };      
              }
          }
          mergedShifts.push(current);
      }
      
      // â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°: ãƒãƒ¼ã‚¸å¾Œã®ä¸è¶³ãƒ‡ãƒ¼ã‚¿ç¢ºèª â˜…â˜…â˜…
      const shortageCountJS = mergedShifts.filter(s => parseInt(s.user_id) < 0).length;
      console.log(`JavaScript DEBUG: ãƒãƒ¼ã‚¸å¾Œã®ã‚·ãƒ•ãƒˆæ•°: ${mergedShifts.length}, ä¸è¶³ãƒ‡ãƒ¼ã‚¿æ•°: ${shortageCountJS}`);
      console.log('ä¸è¶³ãƒ‡ãƒ¼ã‚¿ä¸€è¦§:', mergedShifts.filter(s => parseInt(s.user_id) < 0));

      const minTime = settings.start_time ? new Date(`1970-01-01T${settings.start_time}:00`) : new Date("1970-01-01T08:00:00");
      const maxTime = settings.end_time ? new Date(`1970-01-01T${settings.end_time}:00`) : new Date("1970-01-01T23:00:00");
      
      const groupedByDate = {};
      mergedShifts.forEach(s => {
          if (!groupedByDate[s.date]) groupedByDate[s.date] = [];
          groupedByDate[s.date].push(s);
      });

      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
      const userColorMap = {};
      let colorIndex = 0;

      Object.entries(groupedByDate).forEach(([date, shifts], idx) => {
          const chartId = `chart_${idx}`;
          const container = document.createElement("div");
          container.className = "chart-container";
          container.style.cssText = "margin-bottom:30px; padding:20px; background:#ffffff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);";
          
          container.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom:10px;">
                <h3 style="margin:0; color: #333;">ğŸ“… ${date} ã®ã‚·ãƒ•ãƒˆ</h3>
                <small style="color:#666;">â€»ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å›ºå®š(ãƒ­ãƒƒã‚¯)åˆ‡æ›¿</small>
            </div>
            <div style="height: 400px;"><canvas id="${chartId}"></canvas></div>
          `;
          chartsDiv.appendChild(container);

          const ctx = document.getElementById(chartId).getContext("2d");
          const yLabels = [...new Set(shifts.map(s => s.user_name || `ID:${s.user_id}`))];

          const chartDataPoints = shifts.map(s => {
              const uName = s.user_name || `ID:${s.user_id}`;
              if (!userColorMap[s.user_id]) {
                  userColorMap[s.user_id] = baseColors[colorIndex % baseColors.length];
                  colorIndex++;
              }
              
              let barColor = userColorMap[s.user_id] || "#bdbdbd";
              if (s.type && s.type.indexOf("ä¸è¶³") !== -1) barColor = "#ef5350";
              else if (s.type && s.type.includes("ã‚­ãƒƒãƒãƒ³")) barColor = "#42a5f5";
              else if (s.type && s.type.includes("ãƒ›ãƒ¼ãƒ«")) barColor = "#66bb6a";

              return {
                  x: [new Date(`1970-01-01T${s.start_time}:00`), new Date(`1970-01-01T${s.end_time}:00`)],
                  y: uName,
                  type: s.type,
                  is_locked: s.is_locked || 0,
                  original_user_id: s.user_id,
                  date: s.date,
                  backgroundColor: barColor
              };
          });

          // â˜…â˜…â˜… ä¿®æ­£: ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ â˜…â˜…â˜…
          const chart = new Chart(ctx, {
              type: "bar",
              data: {
                  datasets: [{
                      data: chartDataPoints,
                      backgroundColor: chartDataPoints.map(d => d.backgroundColor),
                      barPercentage: 0.7,
                      borderRadius: 4,
                      borderSkipped: false,
                      borderWidth: ctx => (ctx.raw && ctx.raw.is_locked) ? 3 : 0,
                      borderColor: '#333'
                  }]
              },
              options: {
                  indexAxis: "y",
                  responsive: true,
                  maintainAspectRatio: false,
                  onClick: (e, elements) => {
                      if (elements.length > 0) {
                          const elementIndex = elements[0].index;
                          const dataPoint = chart.data.datasets[0].data[elementIndex];
                          const startTime = dataPoint.x[0].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                          const endTime = dataPoint.x[1].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                          window.toggleLock(dataPoint.original_user_id, dataPoint.date, startTime, endTime, chartId);
                      }
                  },
                  scales: {
                      x: {
                          type: "time",
                          time: { unit: "hour", displayFormats: { hour: "HH:mm" } },
                          min: minTime, max: maxTime,
                          grid: { color: "#f0f0f0" },
                          ticks: { color: "#333" }
                      },
                      y: {
                          type: 'category',
                          labels: yLabels,
                          grid: { display: false },
                          ticks: { color: "#333", font: { weight: 'bold' } }
                      }
                  },
                  plugins: {
                      legend: { display: false },
                      tooltip: {
                          callbacks: {
                              label: c => {
                                  const d = c.raw;
                                  const st = d.x[0].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                                  const en = d.x[1].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                                  return `${d.type}: ${st}ã€œ${en} (${d.is_locked ? "ğŸ”’å›ºå®šä¸­" : "ğŸ”“æœªå›ºå®š"})`;
                              }
                          }
                      }
                  }
              },
              plugins: [{
                id: 'roleLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((element, index) => {
                            const d = dataset.data[index];
                            ctx.font = 'bold 14px "Helvetica Neue", Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            let labelText = (d.type !== 'work') ? d.type : "";
                            if (d.is_locked) labelText = "ğŸ”’ " + labelText;

                            if (labelText) {
                                ctx.lineWidth = 3;
                                ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                                ctx.strokeText(labelText, element.x, element.y);
                                ctx.fillStyle = '#ffffff';
                                ctx.fillText(labelText, element.x, element.y);
                            }
                        });
                    });
                }
              }]
          });
          
          // â˜…â˜…â˜… ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ â˜…â˜…â˜…
          window.chartInstances[chartId] = chart;
      });
    });
  </script>
</head>
<body>
      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="menu-icon" id="menuIcon">â˜°</div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="side-menu" id="sideMenu">
        <div class="close-btn" id="closeBtn">Ã—</div>
        <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
        <a href="/login/manager/home">ğŸ“… ãƒ›ãƒ¼ãƒ </a>
        <a href="/shift/manage">â“ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆç®¡ç†ç”»é¢</a>
        <a href="/insert/">ğŸ‘¥ å¾“æ¥­å“¡ç™»éŒ²</a>
        <a href="/makeshift/settings">âš™ï¸ è¨­å®š</a>
        <a href="/login/logout">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>
 
  {% if settings %}
  <div class="settings-box">
    <h3>ğŸ›  ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
    </ul>
  </div>
  {% endif %}
 
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
 
  <div id="charts"></div>
  {% if shifts and shifts[0] %}
    {% set target_month = shifts[0].date[:7] %} 
    <div class="settings-box" style="border-left: 5px solid #28a745; background: #e9f7ef; margin-top: 20px;">
      <h3 style="color: #28a745;">ğŸ“¢ ã‚·ãƒ•ãƒˆã®å…¬é–‹è¨­å®š (å¯¾è±¡æœˆ: {{ target_month }})</h3>
      <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
        â€»è‡ªå‹•ä½œæˆã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
        å…¬é–‹ã™ã‚‹ã¨ã€å¾“æ¥­å“¡ãŒè‡ªåˆ†ã®ã‚¹ãƒãƒ›ã‹ã‚‰ã‚·ãƒ•ãƒˆã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
      </p>
      <div style="display: flex; gap: 10px;">
        <button onclick="publishShift('{{ target_month }}', 1)" class="btn" style="background: #28a745; color: white; flex: 1;">ğŸš€ ã‚·ãƒ•ãƒˆã‚’å…¬é–‹ã™ã‚‹</button>
        <button onclick="publishShift('{{ target_month }}', 0)" class="btn secondary" style="flex: 1;">ğŸ”’ éå…¬é–‹ã«æˆ»ã™</button>
      </div>
    </div>
  {% endif %}

  <div class="button-group" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
    <a href="{{ url_for('makeshift.auto_calendar', mode='fill') }}" class="btn secondary">â™»ï¸ å†ä½œæˆ(ç©´åŸ‹ã‚)</a>
    <a href="{{ url_for('makeshift.auto_calendar', mode='unlock_all') }}" class="btn" style="background: #ff9800; color: white;" onclick="return confirm('å…¨ã¦ã®ä¿è­·ã‚’è§£é™¤ã—ã¾ã™ã‹?\næ¬¡å›ä½œæˆæ™‚ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')">ğŸ”“ å…¨ä¿è­·è§£é™¤</a>
    <a href="{{ url_for('makeshift.auto_calendar', mode='reset') }}" class="btn danger" onclick="return confirm('å…¨ã¦å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?')">ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ</a>
    
    <button onclick="openHelpModal()" class="btn danger" style="background: #e91e63;">ğŸš¨ ãƒ˜ãƒ«ãƒ—å‹Ÿé›†</button>
  </div>
 
  <div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#d32f2f;">ğŸš¨ ãƒ˜ãƒ«ãƒ—æ€¥å‹Ÿé…ä¿¡</h3>
        <p style="margin-bottom: 15px; color: #666;">æ¡ä»¶ã«åˆã†ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã—ã¾ã™ã€‚</p>
        <label>ğŸ“… æ—¥ä»˜:</label> <input type="date" id="helpDate" class="form-control">
        <label>â° é–‹å§‹:</label> <input type="time" id="helpStart" class="form-control">
        <label>ğŸ çµ‚äº†:</label> <input type="time" id="helpEnd" class="form-control">
        <label>ğŸ‘¤ å‹Ÿé›†ãƒã‚¸ã‚·ãƒ§ãƒ³:</label>
        <select id="helpPosition" class="form-control">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
        <div class="modal-actions">
            <button onclick="closeHelpModal()" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="submitHelpRequest()" class="btn danger">é…ä¿¡</button>
        </div>
    </div>
  </div>

 
    <script>
    // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’å–å¾—â˜…
    function openHelpModal() {
        document.getElementById('helpModal').style.display = 'flex';
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('helpDate').value = today;
        
        // ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’å–å¾—
        loadPositions();
    }

    function closeHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
    }

    // â˜…ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’DBã‹ã‚‰å–å¾—â˜…
    async function loadPositions() {
        const selectElement = document.getElementById('helpPosition');
        
        try {
            const response = await fetch('/line/api/positions'); // âœ… ã“ã‚Œã§Blueprintã®ãƒ«ãƒ¼ãƒˆã¨ä¸€è‡´ã—ã¾ã™ // positionså–å¾—API
            const positions = await response.json();
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
            selectElement.innerHTML = '<option value="">-- ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠ --</option>';
            
            // ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos.id;
                option.textContent = pos.name;
                selectElement.appendChild(option);
            });
            
        } catch (error) {
            console.error('ãƒã‚¸ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            selectElement.innerHTML = '<option value="">èª­ã¿è¾¼ã¿å¤±æ•—</option>';
        }
    }

    // â˜…ãƒ˜ãƒ«ãƒ—å‹Ÿé›†é€ä¿¡ï¼ˆposition_idã‚’å«ã‚ã‚‹ï¼‰â˜…
    async function submitHelpRequest() {
        const date = document.getElementById('helpDate').value;
        const start = document.getElementById('helpStart').value;
        const end = document.getElementById('helpEnd').value;
        const positionId = document.getElementById('helpPosition').value;
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!date || !start || !end) {
            alert('æ—¥ä»˜ã¨æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!positionId) {
            alert('ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (start >= end) {
            alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„');
            return;
        }
        
        try {
            const response = await fetch('/line/api/help/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: date,
                    start_time: start,
                    end_time: end,
                    position_id: parseInt(positionId)  // â˜…ãƒã‚¸ã‚·ãƒ§ãƒ³IDã‚’é€ä¿¡â˜…
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert(`âœ… ${result.target_count}äººã®ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\nãƒã‚¸ã‚·ãƒ§ãƒ³: ${result.position_name}`);
                closeHelpModal();
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error || result.message}`);
            }
            
        } catch (error) {
            console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    }
    </script>
</body>
</html>