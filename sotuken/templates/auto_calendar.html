<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auto_calendar.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
 
</head>
<body>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>
 
  {% if settings %}
  <div class="settings-box">
    <h3>ğŸ›  ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>ä¼‘æ†©æ™‚é–“: {{ settings.break_minutes }}åˆ†</li>
      <li>ã‚·ãƒ•ãƒˆé–“éš”: {{ settings.interval_minutes }}åˆ†</li>
      <li>æœ€å¤§å‹¤å‹™æ™‚é–“: {{ settings.max_hours_per_day }}æ™‚é–“</li>
      <li>æœ€å°å‹¤å‹™æ™‚é–“: {{ settings.min_hours_per_day }}æ™‚é–“</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
      <li>ãƒ¢ãƒ¼ãƒ‰: {{ settings.auto_mode }}</li>
    </ul>
  </div>
  {% endif %}
 
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
 
  {% if shifts %}
    <div id="charts"></div> <!-- ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒªã‚¢ -->
  {% else %}
    <p>ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
 
  <!-- ğŸ¯ ã“ã“ã‚’è¿½åŠ ï¼šãƒœã‚¿ãƒ³ç¾¤ -->
  <div class="button-group">
    <!-- âœ… å†ç·¨é›†ãƒœã‚¿ãƒ³ -->
  <a href="{{ url_for('makeshift.auto_calendar') }}" class="btn secondary">â™»ï¸ å†ç·¨é›†ï¼ˆå†ç”Ÿæˆï¼‰</a>
  </div>
  <div class="back">
    <button class="btn secondary" onclick="location.href='/makeshift/admin'">ğŸ”™ æˆ»ã‚‹</button>
  </div>
 
  <script>
    // Flaskã®Pythonå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆsettingså¤‰æ•°ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æï¼‰
    const shiftData = JSON.parse('{{ shifts|tojson|safe }}');
    const settings = JSON.parse('{{ settings|tojson|safe }}');
    
    // Yè»¸ã®è¡¨ç¤ºç¯„å›²ã‚’è¨­å®šã‹ã‚‰å–å¾—
    const minTime = settings ? new Date(`1970-01-01T${settings.start_time}:00`) : new Date("1970-01-01T08:00:00");
    const maxTime = settings ? new Date(`1970-01-01T${settings.end_time}:00`) : new Date("1970-01-01T19:00:00");
 
 
    const validData = shiftData.filter(s => s.start_time && s.end_time);
 
    if (validData.length === 0) {
      document.getElementById("charts").innerHTML = "<p>æœ‰åŠ¹ãªã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    } else {
      const groupedByDateAndUser = {};
      
      validData.forEach(s => {
        const date = s.date;
        const userId = s.user_id;
        
        if (!groupedByDateAndUser[date]) groupedByDateAndUser[date] = {};
        if (!groupedByDateAndUser[date][userId]) groupedByDateAndUser[date][userId] = [];
        
        groupedByDateAndUser[date][userId].push(s);
      });
 
      const chartsDiv = document.getElementById("charts");
      
      const colors = {};
      let colorIndex = 0;
      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
 
      Object.entries(groupedByDateAndUser).forEach(([date, userShifts], idx) => {
        const container = document.createElement("div");
        container.classList.add("chart-container");
        container.innerHTML = `<h2>ğŸ“… ${date} ã®ã‚·ãƒ•ãƒˆï¼ˆã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼‰</h2><canvas id="chart_${idx}"></canvas>`;
        chartsDiv.appendChild(container);
 
        const ctx = document.getElementById(`chart_${idx}`).getContext("2d");
        
        const chartDataPoints = []; // ğŸ‘ˆ å…¨ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’ã“ã“ã«é›†ç´„
        const yAxisLabels = []; // Yè»¸ã®ãƒ©ãƒ™ãƒ«é †åºã‚’ä¿æŒ (è¡¨ç¤ºé †)
 
        Object.entries(userShifts).forEach(([userId, shifts]) => {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«è‰²ã‚’å‰²ã‚Šå½“ã¦
          if (!colors[userId]) {
            colors[userId] = baseColors[colorIndex % baseColors.length];
            colorIndex++;
          }
          const userColor = colors[userId];
          
          if (!yAxisLabels.includes(userId)) {
              yAxisLabels.push(userId);
          }
 
          shifts.forEach((s) => {
            // Xè»¸ã‚’æ­£ã—ãæ™‚é–“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
            // Chart.jsã¯Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æœŸå¾…
            const start = new Date(`1970-01-01T${s.start_time}:00`);
            const end = new Date(`1970-01-01T${s.end_time}:00`);
            const isBreak = s.type === "break";
            
            chartDataPoints.push({
                x: [start, end],
                y: userId, // Yè»¸ã®å€¤ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæ–‡å­—åˆ—ã®ã¾ã¾
                userLabel: userId,
                type: s.type,
                backgroundColor: isBreak ? "rgba(255, 180, 80, 0.9)" : userColor
            });
          });
        });
 
        // ğŸ¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»å ´é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå®‰å®šã—ãŸè¡¨ç¤ºã®ãŸã‚ï¼‰
        chartDataPoints.sort((a, b) => {
            return yAxisLabels.indexOf(a.userLabel) - yAxisLabels.indexOf(b.userLabel);
        });
 
        // Chart.jsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        new Chart(ctx, {
          type: "bar",
          data: {
            // ãƒ‡ãƒ¼ã‚¿ã‚’å˜ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ã—ã¦æ¸¡ã™
            datasets: [{
                label: "å‹¤å‹™ãƒ»ä¼‘æ†©",
                data: chartDataPoints,
                backgroundColor: chartDataPoints.map(d => d.backgroundColor), // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã”ã¨ã«è‰²ã‚’é©ç”¨
                borderColor: "rgba(0,0,0,0.2)",
                borderWidth: 1,
            }]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: {
                    unit: "hour",
                    displayFormats: { hour: "HH:mm" }
                },
                min: minTime,
                max: maxTime,
                title: { display: true, text: "æ™‚é–“" }
              },
              y: {
                type: 'category',
                labels: yAxisLabels,
                // Yè»¸ã®é †åºã‚’åè»¢ã—ã¦ã€æœ€åˆã«ç™»å ´ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸Šã«ã™ã‚‹
                reverse: true,
                grid: { display: true },
                title: { display: true, text: "ã‚¹ã‚¿ãƒƒãƒ• ID" }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    // ctx.raw ã¯ chartDataPoints ã®è¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
                    const rawData = ctx.raw;
                    const start = new Date(rawData.x[0]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    const end = new Date(rawData.x[1]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    const type = rawData.type === "break" ? "ä¼‘æ†©" : "å‹¤å‹™";
                    return `${rawData.userLabel} (${type}): ${start}ã€œ${end}`;
                  }
                }
              }
            }
          }
        });
        
        // ğŸš¨ è£œè¶³ã‚°ãƒ©ãƒ•: æ™‚é–“å¸¯åˆ¥å¿…è¦äººæ•°ã¨å®Ÿéš›ã®äººæ•° (ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—/ãƒ©ã‚¤ãƒ³ã‚°ãƒ©ãƒ•ã‚‚æœ‰ç”¨ã§ã™ãŒã€ã“ã“ã§ã¯ç°¡å˜ã®ãŸã‚çœç•¥)
        // å’æ¥­ç ”ç©¶ã§ã¯ã€ã“ã®ä¸‹ã« Line Chart ã§æ™‚é–“å¸¯ã®äººæ•°è¶…é/ä¸è¶³ã‚’è¡¨ç¤ºã™ã‚‹ã¨èª¬å¾—åŠ›ãŒå¢—ã—ã¾ã™ã€‚
      });
      // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥åˆè¨ˆå‹¤å‹™æ™‚é–“ã‚°ãƒ©ãƒ•ã®è¿½åŠ  ---
const totalHoursByUser = {};
 
// å‹¤å‹™æ™‚é–“ã¨ä¼‘æ†©æ™‚é–“ã‚’é›†è¨ˆ
validData.forEach(s => {
    if (s.type !== 'work') return; // ä¼‘æ†©æ™‚é–“ã¯å«ã‚ãªã„
 
    const start = new Date(`1970-01-01T${s.start_time}:00`);
    const end = new Date(`1970-01-01T${s.end_time}:00`);
    // å‹¤å‹™æ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’è¨ˆç®—
    const durationMinutes = (end - start) / (1000 * 60);
 
    const userId = s.user_id;
    if (!totalHoursByUser[userId]) {
        totalHoursByUser[userId] = 0;
    }
    totalHoursByUser[userId] += durationMinutes;
});
 
// ãƒ‡ãƒ¼ã‚¿ã‚’ Chart.js å½¢å¼ã«å¤‰æ›
const userLabels = Object.keys(totalHoursByUser);
const totalHoursData = userLabels.map(userId => totalHoursByUser[userId] / 60); // æ™‚é–“å˜ä½ã«å¤‰æ›
 
if (userLabels.length > 0) {
    const totalChartContainer = document.createElement("div");
    totalChartContainer.classList.add("chart-container", "total-chart");
    totalChartContainer.innerHTML = `<h2>âš–ï¸ å…¨ä½“ã®å‹¤å‹™æ™‚é–“ãƒãƒ©ãƒ³ã‚¹</h2><canvas id="total_hours_chart"></canvas>`;
    chartsDiv.appendChild(totalChartContainer);
 
    const totalCtx = document.getElementById("total_hours_chart").getContext("2d");
 
    new Chart(totalCtx, {
        type: "bar",
        data: {
            labels: userLabels,
            datasets: [{
                label: "åˆè¨ˆå‹¤å‹™æ™‚é–“ï¼ˆæ™‚é–“ï¼‰",
                data: totalHoursData,
                backgroundColor: 'rgba(54, 162, 235, 0.8)', // é’è‰²ç³»ã®å˜è‰²
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: { display: true, text: "ã‚¹ã‚¿ãƒƒãƒ• ID" },
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "åˆè¨ˆå‹¤å‹™æ™‚é–“ (H)" },
                    // æœ€å¤§å‹¤å‹™æ™‚é–“ã‚’è¨­å®šå€¤ã‹ã‚‰å‹•çš„ã«è¨­å®šã™ã‚‹ã¨ã•ã‚‰ã«è‰¯ã„
                }
            },
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'å„ã‚¹ã‚¿ãƒƒãƒ•ã®åˆè¨ˆå‹¤å‹™æ™‚é–“' }
            }
        }
    });
}
    }
</script>
</body>
</html>
 
