<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='auto_calendar.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    .chart-container {
      width: 90%;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>
  {% if settings %}
  <div style="margin:20px; padding:10px; background:#eef; border-radius:8px;">
    <h3>ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>ä¼‘æ†©æ™‚é–“: {{ settings.break_minutes }}åˆ†</li>
      <li>ã‚·ãƒ•ãƒˆé–“éš”: {{ settings.interval_minutes }}åˆ†</li>
      <li>æœ€å¤§å‹¤å‹™æ™‚é–“: {{ settings.max_hours_per_day }}æ™‚é–“</li>
      <li>æœ€å°å‹¤å‹™æ™‚é–“: {{ settings.min_hours_per_day }}æ™‚é–“</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
      <li>ãƒ¢ãƒ¼ãƒ‰: {{ settings.auto_mode }}</li>
    </ul>
  </div>
{% endif %}


  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}

  {% if shifts %}
    <div id="charts"></div> <!-- ã‚°ãƒ©ãƒ•ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
  {% else %}
    <p>ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

  <script>
      const shiftData = JSON.parse('{{ shifts|tojson|safe }}');
  console.log("âœ… shiftData:", shiftData);

  // ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ãŒnullï¼‰ã‚’é™¤å¤–
  const validData = shiftData.filter(s => s.start_time && s.end_time);

  if (validData.length === 0) {
    document.getElementById("charts").innerHTML = "<p>æœ‰åŠ¹ãªã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
  } else {
    // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const grouped = {};
    validData.forEach(s => {
      if (!grouped[s.date]) grouped[s.date] = [];
      grouped[s.date].push(s);
    });

    const chartsDiv = document.getElementById("charts");

    // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
    Object.entries(grouped).forEach(([date, items], idx) => {
      const container = document.createElement("div");
      container.classList.add("chart-container");
      container.innerHTML = `<h2>${date}</h2><canvas id="chart_${idx}"></canvas>`;
      chartsDiv.appendChild(container);

      const ctx = document.getElementById(`chart_${idx}`).getContext("2d");

      // ğŸ¨ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ§‹ç¯‰ï¼ˆtypeã«ã‚ˆã£ã¦è‰²ã‚’åˆ†ã‘ã‚‹ï¼‰
      const datasets = items.map((s, i) => {
        const start = new Date(`1970-01-01T${s.start_time}:00`);
        const end = new Date(`1970-01-01T${s.end_time}:00`);

        // ğŸ’¡ typeã«å¿œã˜ã¦è‰²ã¨è¡¨ç¤ºåã‚’å¤‰æ›´
        const isBreak = s.type === "break";
        const color = isBreak ? "rgba(255, 180, 80, 0.7)" : `hsl(${i * 70 % 360}, 70%, 60%)`;
        const label = isBreak ? `${s.user_id}ï¼ˆä¼‘æ†©ï¼‰` : s.user_id;

        return {
          label: label,
          data: [{ x: [start, end], y: s.user_id }],
          backgroundColor: color,
          borderColor: isBreak ? "rgba(255,140,0,1)" : "rgba(0,0,0,0.2)",
          borderWidth: 1,
        };
      });

      // Chart.js ã§æç”»
      new Chart(ctx, {
        type: "bar",
        data: { datasets },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: {
              type: "time",
              time: { unit: "hour", displayFormats: { hour: "HH:mm" } },
              min: new Date("1970-01-01T00:00:00"),
              max: new Date("1970-01-01T23:59:00"),
              title: { display: true, text: "å‹¤å‹™æ™‚é–“" }
            },
            y: { title: { display: true, text: "ã‚¹ã‚¿ãƒƒãƒ•" } }
          },
          plugins: {
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const start = ctx.raw.x[0].toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                  const end = ctx.raw.x[1].toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                  return `${ctx.dataset.label}: ${start}ã€œ${end}`;
                }
              }
            }
          }
        }
      });
    });
  }
  </script>

  <div class="back">
    <button onclick="location.href='/makeshift/admin'">ğŸ”™ æˆ»ã‚‹</button>
  </div>
</body>
</html>
