<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auto_calendar.css') }}">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    window.flaskData = {
      shifts: JSON.parse('{{ shifts|tojson|safe }}') || [],
      settings: JSON.parse('{{ settings|tojson|safe }}') || {}
    };
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // 1. ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
      const menuBtn = document.getElementById('menuBtn');
      const sideMenu = document.getElementById('sideMenu');
      if (menuBtn && sideMenu) {
          menuBtn.addEventListener('click', function() {
              menuBtn.classList.toggle('active');
              sideMenu.classList.toggle('active');
          });
          sideMenu.querySelectorAll('a').forEach(link => {
              link.addEventListener('click', function() {
                  menuBtn.classList.remove('active');
                  sideMenu.classList.remove('active');
              });
          });
      }

      // 2. ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯
      const rawData = window.flaskData.shifts;
      const settings = window.flaskData.settings;
      const chartsDiv = document.getElementById("charts");
      
      if (!rawData || rawData.length === 0 || !chartsDiv) {
          if(chartsDiv) chartsDiv.innerHTML = '<p style="text-align:center; padding:20px;">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
      }

      // â‘  ãƒ‡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDé † -> æ—¥ä»˜é † -> æ™‚é–“é †ï¼‰
      rawData.sort((a, b) => {
          if (a.user_id !== b.user_id) return a.user_id - b.user_id;
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          return a.start_time.localeCompare(b.start_time);
      });

      // â‘¡ çµåˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã“ã“ãŒãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç›´ã™é­”æ³•ï¼ï¼‰
      const mergedShifts = [];
      if (rawData.length > 0) {
          let current = { ...rawData[0] }; 
          for (let i = 1; i < rawData.length; i++) {
              const next = rawData[i];
              
              // ã€ŒåŒã˜äººãƒ»åŒã˜æ—¥ãƒ»åŒã˜å½¹å‰²ãƒ»æ™‚é–“ãŒé€£ç¶šã€ãªã‚‰åˆä½“ã•ã›ã‚‹
              if (current.user_id === next.user_id &&
                  current.date === next.date &&
                  current.type === next.type &&
                  current.end_time === next.start_time) {
                  
                  current.end_time = next.end_time; // çµ‚äº†æ™‚é–“ã‚’å¾Œã‚ã«ä¼¸ã°ã™
              } else {
                  mergedShifts.push(current); // é€”åˆ‡ã‚ŒãŸã‚‰ä¿å­˜
                  current = { ...next };      // æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¸
              }
          }
          mergedShifts.push(current); // æœ€å¾Œã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿å­˜
      }

      // â‘¢ ã‚°ãƒ©ãƒ•è¨­å®š
      const minTime = settings.start_time ? new Date(`1970-01-01T${settings.start_time}:00`) : new Date("1970-01-01T08:00:00");
      const maxTime = settings.end_time ? new Date(`1970-01-01T${settings.end_time}:00`) : new Date("1970-01-01T23:00:00");
      
      const groupedByDate = {};
      mergedShifts.forEach(s => {
          if (!groupedByDate[s.date]) groupedByDate[s.date] = [];
          groupedByDate[s.date].push(s);
      });

      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
      const userColorMap = {};
      let colorIndex = 0;

      // â‘£ æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ©ãƒ•ã‚’æç”»
      Object.entries(groupedByDate).forEach(([date, shifts], idx) => {
          const container = document.createElement("div");
          container.className = "chart-container";
          
          // â–¼ ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ï¼ˆç™½èƒŒæ™¯ã€é»’æ–‡å­—ï¼‰
          container.style.marginBottom = "30px";
          container.style.padding = "20px";
          container.style.background = "#ffffff"; // èƒŒæ™¯ã¯ç™½
          container.style.borderRadius = "8px";
          container.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
          
          // â–¼ æ—¥ä»˜ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—è‰²ã‚’é»’(#333)ã«å¼·åˆ¶æŒ‡å®šï¼
          container.innerHTML = `<h3 style="color: #333333; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">ğŸ“… ${date} ã®ã‚·ãƒ•ãƒˆ</h3><div style="height: 400px;"><canvas id="chart_${idx}"></canvas></div>`;
          chartsDiv.appendChild(container);

          const ctx = document.getElementById(`chart_${idx}`).getContext("2d");
          
          // Yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰
          const yLabels = [...new Set(shifts.map(s => s.user_name || `ID:${s.user_id}`))];

          const chartDataPoints = shifts.map(s => {
              const uName = s.user_name || `ID:${s.user_id}`;
              
              if (!userColorMap[s.user_id]) {
                  userColorMap[s.user_id] = baseColors[colorIndex % baseColors.length];
                  colorIndex++;
              }
              
              // å½¹å‰²ã”ã¨ã®è‰²
              let barColor = userColorMap[s.user_id];
              if (s.type && s.type.includes("ã‚­ãƒƒãƒãƒ³")) barColor = "#e57373"; // èµ¤
              if (s.type && s.type.includes("ãƒ›ãƒ¼ãƒ«")) barColor = "#64b5f6";   // é’

              return {
                  x: [new Date(`1970-01-01T${s.start_time}:00`), new Date(`1970-01-01T${s.end_time}:00`)],
                  y: uName,
                  type: s.type,
                  backgroundColor: barColor
              };
          });

          new Chart(ctx, {
              type: "bar",
              data: {
                  datasets: [{
                      data: chartDataPoints,
                      backgroundColor: chartDataPoints.map(d => d.backgroundColor),
                      barPercentage: 0.7, 
                      borderRadius: 4,
                      borderSkipped: false
                  }]
              },
              options: {
                  indexAxis: "y",
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      x: {
                          type: "time",
                          time: { unit: "hour", displayFormats: { hour: "HH:mm" } },
                          min: minTime, max: maxTime,
                          grid: { color: "#f0f0f0" },
                          ticks: { color: "#333" } // Xè»¸ã®æ–‡å­—è‰²
                      },
                      y: { 
                          type: 'category', 
                          labels: yLabels,
                          grid: { display: false },
                          ticks: { color: "#333", font: { weight: 'bold' } } // Yè»¸ï¼ˆåå‰ï¼‰ã®æ–‡å­—è‰²
                      }
                  },
                  plugins: {
                      legend: { display: false },
                      tooltip: {
                          callbacks: {
                              label: c => {
                                  const d = c.raw;
                                  const st = d.x[0].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                                  const en = d.x[1].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                                  return `${d.type}: ${st}ã€œ${en}`;
                              }
                          }
                      }
                  }
              },
              // ãƒãƒ¼ã®ä¸­ã«æ–‡å­—ï¼ˆå½¹å‰²åï¼‰ã‚’è¡¨ç¤ºã™ã‚‹è¨­å®š
              plugins: [{
                  id: 'roleLabels',
                  afterDatasetsDraw(chart) {
                      const { ctx } = chart;
                      chart.data.datasets.forEach((dataset, i) => {
                          const meta = chart.getDatasetMeta(i);
                          if (!meta.hidden) {
                              meta.data.forEach((element, index) => {
                                  const d = dataset.data[index];
                                  // "work" ä»¥å¤–ã®ã¨ãã«æ–‡å­—ã‚’è¡¨ç¤º
                                  if (d.type && d.type !== 'work') {
                                      ctx.fillStyle = '#ffffff'; // ãƒãƒ¼ã®ä¸­ã®æ–‡å­—ã¯ç™½
                                      ctx.font = 'bold 12px "Helvetica Neue", Arial';
                                      ctx.textAlign = 'center';
                                      ctx.textBaseline = 'middle';
                                      // æ–‡å­—ã«å½±ã‚’ã¤ã‘ã¦èª­ã¿ã‚„ã™ã
                                      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                                      ctx.shadowBlur = 3;
                                      ctx.fillText(d.type, element.x, element.y);
                                      ctx.shadowBlur = 0;
                                  }
                              });
                          }
                      });
                  }
              }]
          });
      });
    });
  </script>
</head>
<body>

  <div class="menu-btn" id="menuBtn">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <nav class="side-menu" id="sideMenu">
    <ul>
      <li><a href="{{ url_for('makeshift.show_admin_shift') }}">å¸Œæœ›ä¸€è¦§</a></li>
      <li><a href="#">å±¥æ­´</a></li> 
      <li><a href="{{ url_for('makeshift.settings') }}">è¨­å®š</a></li>
      <li><a href="#">å¾“æ¥­å“¡ç™»éŒ²</a></li>
    </ul>
  </nav>

  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>
 
  {% if settings %}
  <div class="settings-box">
    <h3>ğŸ›  ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
    </ul>
  </div>
  {% endif %}
 
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
 
  <div id="charts"></div> 
 
  <div class="button-group" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; margin-bottom: 50px;">
    <a href="{{ url_for('makeshift.auto_calendar') }}" class="btn secondary">â™»ï¸ å†ç·¨é›†ï¼ˆå†ç”Ÿæˆï¼‰</a>
    <button onclick="openHelpModal()" class="btn danger">ğŸš¨ ãƒ˜ãƒ«ãƒ—å‹Ÿé›†</button>
  </div>

  <div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#d32f2f;">ğŸš¨ ãƒ˜ãƒ«ãƒ—æ€¥å‹Ÿé…ä¿¡</h3>
        <p style="margin-bottom: 15px; color: #666;">æ¡ä»¶ã«åˆã†ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã—ã¾ã™ã€‚</p>
        <label>ğŸ“… æ—¥ä»˜:</label> <input type="date" id="helpDate" class="form-control">
        <label>â° é–‹å§‹:</label> <input type="time" id="helpStart" class="form-control">
        <label>ğŸ çµ‚äº†:</label> <input type="time" id="helpEnd" class="form-control">
        <div class="modal-actions">
            <button onclick="closeHelpModal()" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="submitHelpRequest()" class="btn danger">é…ä¿¡</button>
        </div>
    </div>
  </div>
  
  <script>
    function openHelpModal() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
    
    // ğŸš¨ ä¿®æ­£: ã‚µãƒ¼ãƒãƒ¼ã¸ã®APIå‘¼ã³å‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£… ğŸš¨
    async function submitHelpRequest() {
        const helpDate = document.getElementById('helpDate').value;
        const helpStart = document.getElementById('helpStart').value;
        const helpEnd = document.getElementById('helpEnd').value;
        
        // å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!helpDate || !helpStart || !helpEnd) {
            alert('æ—¥ä»˜ã¨æ™‚é–“ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const btn = document.querySelector('#helpModal .btn.danger');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = 'é…ä¿¡ä¸­...';

        try {
            const response = await fetch("{{ url_for('makeshift.create_help_request') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: helpDate,
                    start_time: helpStart,
                    end_time: helpEnd
                })
            });

            closeHelpModal(); // å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

            const result = await response.json();

            if (response.ok) {
                // æˆåŠŸæ™‚
                alert(`ğŸ‰ å‹Ÿé›†ã‚’é…ä¿¡ã—ã¾ã—ãŸï¼ (${result.target_count} åã«é€šçŸ¥)`);
            } else {
                // å¤±æ•—æ™‚ (ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º)
                alert(`âŒ é…ä¿¡å¤±æ•—: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
            }

        } catch (error) {
            console.error('API Error:', error);
            alert('é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
</script>
</body>
</html>