<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auto_calendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/hamburger.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSå¤‰æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
    window.flaskData = {
      shifts: JSON.parse('{{ shifts|tojson|safe }}') || [],
      settings: JSON.parse('{{ settings|tojson|safe }}') || {}
    };
    
    window.chartInstances = {};
    
    window.chartSettings = {
      heightPerPerson: 60,
      maxHeight: 800,
      displayMode: 'all'
    };
  </script>
 
<script>
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSå¤‰æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
  window.flaskData = {
    shifts: JSON.parse('{{ shifts|tojson|safe }}') || [],
    settings: JSON.parse('{{ settings|tojson|safe }}') || {}
  };
  
  window.chartInstances = {};
  
  // â˜…â˜…â˜… ã‚°ãƒ©ãƒ•è¨­å®šã‚’ä¿å­˜ â˜…â˜…â˜…
  window.chartSettings = {
    heightPerPerson: 60,  // 1äººã‚ãŸã‚Šã®é«˜ã•
    maxHeight: 800,       // æœ€å¤§é«˜ã•
    displayMode: 'all'    // 'all', 'daily', 'weekly'
  };
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
    const menuIcon = document.getElementById('menuIcon');
    const sideMenu = document.getElementById('sideMenu');
    const closeBtn = document.getElementById('closeBtn');
    
    if (menuIcon && sideMenu) {
      menuIcon.addEventListener('click', function() {
        sideMenu.classList.add('active');
      });
    }
    
    if (closeBtn && sideMenu) {
      closeBtn.addEventListener('click', function() {
        sideMenu.classList.remove('active');
      });
    }
    
    if (sideMenu) {
      sideMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function() {
          sideMenu.classList.remove('active');
        });
      });
    }

    // ========================================================
    // 2. å…¬é–‹ãƒ»éå…¬é–‹åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    // ========================================================
    window.publishShift = async function(month, status) {
      const action = status === 1 ? "å…¬é–‹" : "éå…¬é–‹";
      if (!confirm(`${month} åˆ†ã®ã‚·ãƒ•ãƒˆã‚’ ${action} ã«ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

      try {
        const response = await fetch("/makeshift/api/publish_status", {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ month: month, status: status })
        });
        const result = await response.json();

        if (result.success) {
          alert(`âœ… ${result.message}`);
          location.reload();
        } else {
          alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.message}`);
        }
      } catch (error) {
        console.error('API Error:', error);
        alert('é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    };

    // ========================================================
    // â˜…â˜…â˜… ãƒ­ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆé–¢æ•° â˜…â˜…â˜…
    // ========================================================
    window.toggleLock = async function(userId, date, startTime, endTime, chartId) {
      if (!userId || parseInt(userId) < 0) {
        showToast("âš ï¸ ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒƒã‚¯ã§ãã¾ã›ã‚“");
        return;
      }

      try {
        const response = await fetch('/makeshift/toggle_lock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_id: userId, 
            date: date,
            start_time: startTime,
            end_time: endTime
          })
        });
        const result = await response.json();
        
        if (result.status === 'success') {
          window.flaskData.shifts.forEach(s => {
            if (s.user_id == userId && s.date == date && 
                s.start_time == startTime && s.end_time == endTime) {
              s.is_locked = result.new_state;
            }
          });
          
          const chart = window.chartInstances[chartId];
          if (chart) {
            chart.data.datasets[0].data.forEach(d => {
              if (d.original_user_id == userId && d.date == date &&
                  d.x[0].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) == startTime &&
                  d.x[1].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) == endTime) {
                d.is_locked = result.new_state;
              }
            });
            chart.update();
          }
          
          showToast(result.new_state === 1 ? "ğŸ”’ ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ" : "ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ");
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
        }
      } catch (e) {
        console.error(e);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };

    function showToast(msg) {
      const toast = document.createElement("div");
      toast.innerText = msg;
      toast.style.position = "fixed";
      toast.style.bottom = "20px";
      toast.style.right = "20px";
      toast.style.background = "rgba(0,0,0,0.8)";
      toast.style.color = "#fff";
      toast.style.padding = "10px 20px";
      toast.style.borderRadius = "5px";
      toast.style.zIndex = "9999";
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // ========================================================
    // â˜…â˜…â˜… é€±ã®é–‹å§‹æ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
    // ========================================================
    function getWeekStart(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDay();
      const diff = date.getDate() - day; // æ—¥æ›œæ—¥ã‚’é€±ã®é–‹å§‹ã¨ã™ã‚‹
      const weekStart = new Date(date.setDate(diff));
      return weekStart.toISOString().split('T')[0];
    }

    // ========================================================
    // â˜…â˜…â˜… é€±ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ– â˜…â˜…â˜…
    // ========================================================
    function groupByWeek(groupedByDate) {
      const weekGroups = {};
      
      Object.keys(groupedByDate).forEach(date => {
        const weekStart = getWeekStart(date);
        if (!weekGroups[weekStart]) {
          weekGroups[weekStart] = {};
        }
        weekGroups[weekStart][date] = groupedByDate[date];
      });
      
      return weekGroups;
    }

    // ========================================================
    // â˜…â˜…â˜… é€±ã®ç¯„å›²ã‚’è¡¨ç¤ºå½¢å¼ã«å¤‰æ› â˜…â˜…â˜…
    // ========================================================
    function getWeekLabel(weekStart, dates) {
      const sortedDates = Object.keys(dates).sort();
      const start = sortedDates[0];
      const end = sortedDates[sortedDates.length - 1];
      return `${start} ã€œ ${end}`;
    }

    // ========================================================
    // â˜…â˜…â˜… ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•° â˜…â˜…â˜…
    // ========================================================
    window.showChart = function(identifier) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã® active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      event.target.classList.add('active');
      
      // ã™ã¹ã¦ã®ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
      document.querySelectorAll('.chart-day-container, .chart-week-container').forEach(container => {
        container.style.display = 'none';
      });
      
      // é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
      const targetContainer = document.getElementById(`container_${identifier}`);
      if (targetContainer) {
        targetContainer.style.display = 'block';
      }
    };

    // ========================================================
    // â˜…â˜…â˜… ã‚°ãƒ©ãƒ•å†æç”»é–¢æ•° â˜…â˜…â˜…
    // ========================================================
    window.redrawCharts = function() {
      const chartsDiv = document.getElementById("charts");
      if (!chartsDiv) return;
      
      // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’å‰Šé™¤
      Object.values(window.chartInstances).forEach(chart => chart.destroy());
      window.chartInstances = {};
      chartsDiv.innerHTML = '';
      
      // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
      drawCharts();
    };

    // ========================================================
    // â˜…â˜…â˜… ã‚°ãƒ©ãƒ•æç”»é–¢æ•° â˜…â˜…â˜…
    // ========================================================
    function drawCharts() {
      const rawData = window.flaskData.shifts;
      const settings = window.flaskData.settings;
      const chartsDiv = document.getElementById("charts");
      
      console.log('rawDataç·æ•°:', rawData.length);
      
      if (!rawData || rawData.length === 0 || !chartsDiv) {
        if(chartsDiv) chartsDiv.innerHTML = '<p style="text-align:center; padding:20px;">ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      rawData.sort((a, b) => {
        const idA = parseInt(a.user_id);
        const idB = parseInt(b.user_id);
        const isStaffA = idA > 0;
        const isStaffB = idB > 0;
        
        if (isStaffA && !isStaffB) return -1;
        if (!isStaffA && isStaffB) return 1;
        if (a.start_time !== b.start_time) return a.start_time.localeCompare(b.start_time);
        if (a.end_time !== b.end_time) return a.end_time.localeCompare(b.end_time);
        return idA - idB;
      });

      const mergedShifts = [];
      if (rawData.length > 0) {
        let current = { ...rawData[0] };
        for (let i = 1; i < rawData.length; i++) {
          const next = rawData[i];
          
          const shouldMerge = (
            parseInt(current.user_id) > 0 &&
            current.user_id === next.user_id &&
            current.date === next.date &&
            current.type === next.type &&
            (current.is_locked || 0) === (next.is_locked || 0) &&
            current.end_time === next.start_time
          );
          
          if (shouldMerge) {
            current.end_time = next.end_time;
          } else {
            mergedShifts.push(current);
            current = { ...next };
          }
        }
        mergedShifts.push(current);
      }

      const minTime = settings.start_time ? new Date(`1970-01-01T${settings.start_time}:00`) : new Date("1970-01-01T08:00:00");
      const maxTime = settings.end_time ? new Date(`1970-01-01T${settings.end_time}:00`) : new Date("1970-01-01T23:00:00");
      
      const groupedByDate = {};
      mergedShifts.forEach(s => {
        if (!groupedByDate[s.date]) groupedByDate[s.date] = [];
        groupedByDate[s.date].push(s);
      });

      const displayMode = window.chartSettings.displayMode;

      // â˜…â˜…â˜… è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç† â˜…â˜…â˜…
      if (displayMode === 'all') {
        // å…¨æ—¥è¡¨ç¤ºï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
        drawAllCharts(groupedByDate, minTime, maxTime);
      } else if (displayMode === 'daily') {
        // æ—¥åˆ¥ã‚¿ãƒ–è¡¨ç¤º
        drawDailyTabs(groupedByDate, minTime, maxTime);
      } else if (displayMode === 'weekly') {
        // é€±åˆ¥ã‚¿ãƒ–è¡¨ç¤º
        drawWeeklyTabs(groupedByDate, minTime, maxTime);
      }
    }

    // ========================================================
    // â˜…â˜…â˜… å…¨æ—¥è¡¨ç¤º â˜…â˜…â˜…
    // ========================================================
    function drawAllCharts(groupedByDate, minTime, maxTime) {
      const chartsDiv = document.getElementById("charts");
      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
      const userColorMap = {};
      let colorIndex = 0;

      Object.entries(groupedByDate).forEach(([date, shifts], idx) => {
        createChartContainer(date, shifts, `chart_${idx}`, minTime, maxTime, userColorMap, baseColors, colorIndex, false);
      });
    }

    // ========================================================
    // â˜…â˜…â˜… æ—¥åˆ¥ã‚¿ãƒ–è¡¨ç¤º â˜…â˜…â˜…
    // ========================================================
    function drawDailyTabs(groupedByDate, minTime, maxTime) {
      const chartsDiv = document.getElementById("charts");
      const dates = Object.keys(groupedByDate).sort();
      
      // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      const tabsHtml = dates.map((date, i) => 
        `<button class="tab-btn ${i===0?'active':''}" onclick="showChart('${date.replace(/-/g, '')}')">${date}</button>`
      ).join('');
      
      chartsDiv.innerHTML = `
        <div class="tabs" style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          ${tabsHtml}
        </div>
        <div id="chart-area"></div>
      `;

      const chartArea = document.getElementById('chart-area');
      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
      const userColorMap = {};
      let colorIndex = 0;

      dates.forEach((date, idx) => {
        const shifts = groupedByDate[date];
        const containerId = `container_${date.replace(/-/g, '')}`;
        
        const wrapper = document.createElement('div');
        wrapper.id = containerId;
        wrapper.className = 'chart-day-container';
        wrapper.style.display = idx === 0 ? 'block' : 'none';
        chartArea.appendChild(wrapper);
        
        createChartContainer(date, shifts, `chart_daily_${idx}`, minTime, maxTime, userColorMap, baseColors, colorIndex, true, wrapper);
      });
    }

    // ========================================================
    // â˜…â˜…â˜… é€±åˆ¥ã‚¿ãƒ–è¡¨ç¤º â˜…â˜…â˜…
    // ========================================================
    function drawWeeklyTabs(groupedByDate, minTime, maxTime) {
      const chartsDiv = document.getElementById("charts");
      const weekGroups = groupByWeek(groupedByDate);
      const weeks = Object.keys(weekGroups).sort();
      
      // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      const tabsHtml = weeks.map((weekStart, i) => {
        const weekLabel = getWeekLabel(weekStart, weekGroups[weekStart]);
        return `<button class="tab-btn ${i===0?'active':''}" onclick="showChart('week_${weekStart.replace(/-/g, '')}')">${weekLabel}</button>`;
      }).join('');
      
      chartsDiv.innerHTML = `
        <div class="tabs" style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          ${tabsHtml}
        </div>
        <div id="chart-area"></div>
      `;

      const chartArea = document.getElementById('chart-area');
      const baseColors = ["hsl(0, 70%, 60%)", "hsl(70, 70%, 60%)", "hsl(140, 70%, 60%)", "hsl(210, 70%, 60%)", "hsl(280, 70%, 60%)"];
      const userColorMap = {};
      let colorIndex = 0;

      weeks.forEach((weekStart, weekIdx) => {
        const weekDates = weekGroups[weekStart];
        const containerId = `container_week_${weekStart.replace(/-/g, '')}`;
        
        const weekWrapper = document.createElement('div');
        weekWrapper.id = containerId;
        weekWrapper.className = 'chart-week-container';
        weekWrapper.style.display = weekIdx === 0 ? 'block' : 'none';
        chartArea.appendChild(weekWrapper);
        
        // é€±å†…ã®å„æ—¥ä»˜ã®ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
        Object.entries(weekDates).sort().forEach(([date, shifts], dayIdx) => {
          createChartContainer(date, shifts, `chart_week_${weekIdx}_day_${dayIdx}`, minTime, maxTime, userColorMap, baseColors, colorIndex, true, weekWrapper);
        });
      });
    }

    // ========================================================
    // â˜…â˜…â˜… ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠä½œæˆï¼ˆå…±é€šé–¢æ•°ï¼‰ â˜…â˜…â˜…
    // ========================================================
    function createChartContainer(date, shifts, chartId, minTime, maxTime, userColorMap, baseColors, colorIndex, isTabMode, parentElement = null) {
      const container = document.createElement("div");
      container.className = "chart-container";
      container.style.cssText = "margin-bottom:30px; padding:20px; background:#ffffff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);";
      
      const yLabels = [...new Set(shifts.map(s => s.user_name || `ID:${s.user_id}`))];
      const dynamicHeight = Math.max(400, yLabels.length * window.chartSettings.heightPerPerson);
      const maxHeight = window.chartSettings.maxHeight;
      
      container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom:10px;">
          <h3 style="margin:0; color: #333;">ğŸ“… ${date} ã®ã‚·ãƒ•ãƒˆ (${yLabels.length}å)</h3>
          <small style="color:#666;">â€»ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å›ºå®š(ãƒ­ãƒƒã‚¯)åˆ‡æ›¿</small>
        </div>
        <div style="height: ${Math.min(dynamicHeight, maxHeight)}px; overflow-y: auto; overflow-x: hidden;">
          <canvas id="${chartId}" style="height: ${dynamicHeight}px;"></canvas>
        </div>
      `;
      
      if (parentElement) {
        parentElement.appendChild(container);
      } else {
        document.getElementById("charts").appendChild(container);
      }

      const ctx = document.getElementById(chartId).getContext("2d");

      const chartDataPoints = shifts.map(s => {
        const uName = s.user_name || `ID:${s.user_id}`;
        if (!userColorMap[s.user_id]) {
          userColorMap[s.user_id] = baseColors[colorIndex % baseColors.length];
          colorIndex++;
        }
        
        let barColor = userColorMap[s.user_id] || "#bdbdbd";
        if (s.type && s.type.indexOf("ä¸è¶³") !== -1) barColor = "#ef5350";
        else if (s.type && s.type.includes("ã‚­ãƒƒãƒãƒ³")) barColor = "#42a5f5";
        else if (s.type && s.type.includes("ãƒ›ãƒ¼ãƒ«")) barColor = "#66bb6a";

        return {
          x: [new Date(`1970-01-01T${s.start_time}:00`), new Date(`1970-01-01T${s.end_time}:00`)],
          y: uName,
          type: s.type,
          is_locked: s.is_locked || 0,
          original_user_id: s.user_id,
          date: s.date,
          backgroundColor: barColor
        };
      });

      const chart = new Chart(ctx, {
        type: "bar",
        data: {
          datasets: [{
            data: chartDataPoints,
            backgroundColor: chartDataPoints.map(d => d.backgroundColor),
            barPercentage: 0.7,
            borderRadius: 4,
            borderSkipped: false,
            borderWidth: ctx => (ctx.raw && ctx.raw.is_locked) ? 3 : 0,
            borderColor: '#333'
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e, elements) => {
            if (elements.length > 0) {
              const elementIndex = elements[0].index;
              const dataPoint = chart.data.datasets[0].data[elementIndex];
              const startTime = dataPoint.x[0].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
              const endTime = dataPoint.x[1].toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
              window.toggleLock(dataPoint.original_user_id, dataPoint.date, startTime, endTime, chartId);
            }
          },
          scales: {
            x: {
              type: "time",
              time: { unit: "hour", displayFormats: { hour: "HH:mm" } },
              min: minTime, max: maxTime,
              grid: { color: "#f0f0f0" },
              ticks: { color: "#333" }
            },
            y: {
              type: 'category',
              labels: yLabels,
              grid: { display: false },
              ticks: { color: "#333", font: { weight: 'bold' } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: c => {
                  const d = c.raw;
                  const st = d.x[0].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                  const en = d.x[1].toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                  return `${d.type}: ${st}ã€œ${en} (${d.is_locked ? "ğŸ”’å›ºå®šä¸­" : "ğŸ”“æœªå›ºå®š"})`;
                }
              }
            }
          }
        },
        plugins: [{
          id: 'roleLabels',
          afterDatasetsDraw(chart) {
            const { ctx } = chart;
            chart.data.datasets.forEach((dataset, i) => {
              const meta = chart.getDatasetMeta(i);
              meta.data.forEach((element, index) => {
                const d = dataset.data[index];
                ctx.font = 'bold 14px "Helvetica Neue", Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                let labelText = (d.type !== 'work') ? d.type : "";
                if (d.is_locked) labelText = "ğŸ”’ " + labelText;

                if (labelText) {
                  ctx.lineWidth = 3;
                  ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                  ctx.strokeText(labelText, element.x, element.y);
                  ctx.fillStyle = '#ffffff';
                  ctx.fillText(labelText, element.x, element.y);
                }
              });
            });
          }
        }]
      });
      
      window.chartInstances[chartId] = chart;
    }

    // åˆå›æç”»
    drawCharts();
  });
</script>
</head>
<body>
      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="menu-icon" id="menuIcon">â˜°</div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="side-menu" id="sideMenu">
        <div class="close-btn" id="closeBtn">Ã—</div>
        <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
        <a href="/login/manager/home">ğŸ“… ãƒ›ãƒ¼ãƒ </a>
        <a href="/shift/manage">â“ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆç®¡ç†ç”»é¢</a>
        <a href="/insert/">ğŸ‘¥ å¾“æ¥­å“¡ç™»éŒ²</a>
        <a href="/makeshift/settings">âš™ï¸ è¨­å®š</a>
        <a href="/login/logout">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
  <header>è‡ªå‹•ä½œæˆã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</header>
<!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºè¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="settings-box" style="margin: 20px auto; max-width: 800px;">
  <h3>ğŸ“Š ã‚°ãƒ©ãƒ•è¡¨ç¤ºè¨­å®š</h3>
  
  <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
  <div style="margin-bottom: 20px;">
    <label style="display: block; margin-bottom: 10px; font-weight: bold;">
      ğŸ“‹ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:
    </label>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
        <input type="radio" name="displayMode" value="all" checked onchange="updateDisplayMode(this.value)">
        <span>å…¨æ—¥è¡¨ç¤º</span>
      </label>
      <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
        <input type="radio" name="displayMode" value="daily" onchange="updateDisplayMode(this.value)">
        <span>æ—¥åˆ¥ã‚¿ãƒ–</span>
      </label>
      <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
        <input type="radio" name="displayMode" value="weekly" onchange="updateDisplayMode(this.value)">
        <span>é€±åˆ¥ã‚¿ãƒ–</span>
      </label>
    </div>
    <small style="color: #666;">â€»é€±åˆ¥ã‚¿ãƒ–ã¯æ—¥æ›œæ—¥ã‚’é€±ã®é–‹å§‹æ—¥ã¨ã—ã¾ã™</small>
  </div>
  
  <!-- ã‚µã‚¤ã‚ºè¨­å®š -->
  <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 200px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">
        1äººã‚ãŸã‚Šã®é«˜ã• (px):
      </label>
      <input type="number" id="heightPerPerson" value="60" min="30" max="150" step="10" 
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <small style="color: #666;">æ¨å¥¨: 40ã€œ80px</small>
    </div>
    
    <div style="flex: 1; min-width: 200px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">
        æœ€å¤§è¡¨ç¤ºé«˜ã• (px):
      </label>
      <input type="number" id="maxHeight" value="800" min="400" max="2000" step="100" 
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <small style="color: #666;">ã“ã®é«˜ã•ã‚’è¶…ãˆã‚‹ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¡¨ç¤º</small>
    </div>
    
    <button onclick="applyChartSettings()" class="btn" style="background: #2196F3; color: white; padding: 8px 20px; white-space: nowrap;">
      âš™ï¸ é©ç”¨
    </button>
  </div>
</div>


<script>
  function updateDisplayMode(mode) {
    window.chartSettings.displayMode = mode;
    window.redrawCharts();
    showToast(`ğŸ“‹ ${mode === 'all' ? 'å…¨æ—¥è¡¨ç¤º' : mode === 'daily' ? 'æ—¥åˆ¥ã‚¿ãƒ–' : 'é€±åˆ¥ã‚¿ãƒ–'}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);
  }
  
  function applyChartSettings() {
    const heightPerPerson = parseInt(document.getElementById('heightPerPerson').value);
    const maxHeight = parseInt(document.getElementById('maxHeight').value);
    
    if (heightPerPerson < 30 || heightPerPerson > 150) {
      alert('1äººã‚ãŸã‚Šã®é«˜ã•ã¯30ã€œ150pxã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    if (maxHeight < 400 || maxHeight > 2000) {
      alert('æœ€å¤§è¡¨ç¤ºé«˜ã•ã¯400ã€œ2000pxã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    window.chartSettings.heightPerPerson = heightPerPerson;
    window.chartSettings.maxHeight = maxHeight;
    
    window.redrawCharts();
    
    showToast('âœ… è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ');
  }
  
  function showToast(msg) {
    const toast = document.createElement("div");
    toast.innerText = msg;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = "rgba(0,0,0,0.8)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "5px";
    toast.style.zIndex = "9999";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
</script>
 
  {% if settings %}
  <div class="settings-box">
    <h3>ğŸ›  ç¾åœ¨ã®è‡ªå‹•ç”Ÿæˆè¨­å®š</h3>
    <ul>
      <li>é–‹å§‹æ™‚é–“: {{ settings.start_time }}</li>
      <li>çµ‚äº†æ™‚é–“: {{ settings.end_time }}</li>
      <li>æ™‚é–“å¸¯æœ€å¤§äººæ•°: {{ settings.max_people_per_shift }}</li>
    </ul>
  </div>
  {% endif %}
 
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
 
<div id="charts"></div>

{% if shifts and shifts[0] %}
  {% set target_month = shifts[0].date[:7] %}
  <div id="stickyHeader">
    <div class="settings-box public-status">
      <h3>ğŸ“¢ ã‚·ãƒ•ãƒˆã®å…¬é–‹è¨­å®š (å¯¾è±¡æœˆ: {{ target_month }})</h3>
      <p>
        â€»è‡ªå‹•ä½œæˆã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
        å…¬é–‹ã™ã‚‹ã¨ã€å¾“æ¥­å“¡ãŒè‡ªåˆ†ã®ã‚¹ãƒãƒ›ã‹ã‚‰ã‚·ãƒ•ãƒˆã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
      </p>
      <div style="display: flex; gap: 10px; width: 100%;">
        <button onclick="publishShift('{{ target_month }}', 1)" class="btn" style="flex: 1;">ğŸš€ ã‚·ãƒ•ãƒˆã‚’å…¬é–‹ã™ã‚‹</button>
        <button onclick="publishShift('{{ target_month }}', 0)" class="btn secondary" style="flex: 1;">ğŸ”’ éå…¬é–‹ã«æˆ»ã™</button>
      </div>
    </div>
{% endif %}

    <div class="button-group">
      <a href="{{ url_for('makeshift.auto_calendar', mode='fill') }}" class="btn secondary">â™»ï¸ å†ä½œæˆ(ç©´åŸ‹ã‚)</a>
      <!-- <a href="{{ url_for('makeshift.auto_calendar', mode='unlock_all') }}" class="btn" style="background: #ff9800;" onclick="return confirm('å…¨ã¦ã®ä¿è­·ã‚’è§£é™¤ã—ã¾ã™ã‹?\næ¬¡å›ä½œæˆæ™‚ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')">ğŸ”“ å…¨ä¿è­·è§£é™¤</a>
      <a href="{{ url_for('makeshift.auto_calendar', mode='reset') }}" class="btn danger" onclick="return confirm('å…¨ã¦å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?')">ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ</a> -->
      <button onclick="openHelpModal()" class="btn danger" style="background: #e91e63;">ğŸš¨ ãƒ˜ãƒ«ãƒ—å‹Ÿé›†</button>
    </div>
  </div>

<div id="helpModal" class="modal-overlay">
  <div class="modal-content">
    <h3>ğŸš¨ ãƒ˜ãƒ«ãƒ—æ€¥å‹Ÿé…ä¿¡</h3>
    <p>æ¡ä»¶ã«åˆã†ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã—ã¾ã™ã€‚</p>
    
    <label>ğŸ“… æ—¥ä»˜:</label>
    <input type="date" id="helpDate" class="form-control">
    
    <label>â° é–‹å§‹:</label>
    <input type="time" id="helpStart" class="form-control">
    
    <label>ğŸ çµ‚äº†:</label>
    <input type="time" id="helpEnd" class="form-control">
    
    <label>ğŸ‘¤ å‹Ÿé›†ãƒã‚¸ã‚·ãƒ§ãƒ³:</label>
    <select id="helpPosition" class="form-control">
      <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
    </select>
    
    <div class="modal-actions">
      <button onclick="closeHelpModal()" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="submitHelpRequest()" class="btn danger">é…ä¿¡</button>
    </div>
  </div>
</div>
 
    <script>
    // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’å–å¾—â˜…
    function openHelpModal() {
        document.getElementById('helpModal').style.display = 'flex';
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('helpDate').value = today;
        
        // ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’å–å¾—
        loadPositions();
    }

    function closeHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
    }

    // â˜…ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’DBã‹ã‚‰å–å¾—â˜…
    async function loadPositions() {
        const selectElement = document.getElementById('helpPosition');
        
        try {
            const response = await fetch('/line/api/positions'); // âœ… ã“ã‚Œã§Blueprintã®ãƒ«ãƒ¼ãƒˆã¨ä¸€è‡´ã—ã¾ã™ // positionså–å¾—API
            const positions = await response.json();
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
            selectElement.innerHTML = '<option value="">-- ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠ --</option>';
            
            // ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos.id;
                option.textContent = pos.name;
                selectElement.appendChild(option);
            });
            
        } catch (error) {
            console.error('ãƒã‚¸ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            selectElement.innerHTML = '<option value="">èª­ã¿è¾¼ã¿å¤±æ•—</option>';
        }
    }

    // â˜…ãƒ˜ãƒ«ãƒ—å‹Ÿé›†é€ä¿¡ï¼ˆposition_idã‚’å«ã‚ã‚‹ï¼‰â˜…
    async function submitHelpRequest() {
        const date = document.getElementById('helpDate').value;
        const start = document.getElementById('helpStart').value;
        const end = document.getElementById('helpEnd').value;
        const positionId = document.getElementById('helpPosition').value;
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!date || !start || !end) {
            alert('æ—¥ä»˜ã¨æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!positionId) {
            alert('ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (start >= end) {
            alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„');
            return;
        }
        
        try {
            const response = await fetch('/line/api/help/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: date,
                    start_time: start,
                    end_time: end,
                    position_id: parseInt(positionId)  // â˜…ãƒã‚¸ã‚·ãƒ§ãƒ³IDã‚’é€ä¿¡â˜…
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert(`âœ… ${result.target_count}äººã®ã‚¹ã‚¿ãƒƒãƒ•ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\nãƒã‚¸ã‚·ãƒ§ãƒ³: ${result.position_name}`);
                closeHelpModal();
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error || result.message}`);
            }
            
        } catch (error) {
            console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    }

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã«å½±ã‚’è¿½åŠ ã™ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    window.addEventListener('scroll', function() {
        const header = document.getElementById('stickyHeader');
        if (header) {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
        }
    });
    </script>
</body>
</html>