<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>希望入力 | ShiftForm</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sinsei.css') }}">
</head>
<body>
  <div class="overlay"></div>

  <div class="container">
    <h1 class="title"><span class="logo">M</span>{{ date }} の希望入力</h1>
    
    <!-- ★修正：状況に応じた警告を3パターンに分岐 -->
    {% if is_locked and is_late %}
      <!-- パターン：期限外 + 確定済み → 完全ブロック -->
      <div style="background:#f8d7da; color:#721c24; padding:15px; border-radius:5px; margin-bottom:15px; border:1px solid #f5c6cb;">
        <strong>⛔ 提出不可</strong><br>
        期限を過ぎており、シフトが確定しているため、変更できません。
      </div>
    {% elif is_locked and not is_late %}
      <!-- パターン：期限内 + 確定済み → 警告付きで変更可能 -->
      <div style="background:#fff3cd; color:#856404; padding:15px; border-radius:5px; margin-bottom:15px; border:1px solid #ffeeba;">
        <strong>⚠️ シフト確定済み（調整可能）</strong><br>
        シフトは確定されていますが、期限内のため微調整が可能です。
      </div>
    {% elif is_late and not is_locked %}
      <!-- パターン：期限外 + 未確定 → 警告付きで変更可能 -->
      <div style="background:#fff3cd; color:#856404; padding:15px; border-radius:5px; margin-bottom:15px; border:1px solid #ffeeba;">
        <strong>⚠️ 提出期限を過ぎています</strong><br>
        変更は可能ですが、管理者に通知されます。
      </div>
    {% else %}
      <!-- パターン：期限内 + 未確定 → 通常（情報表示） -->
      <div style="background:#d1ecf1; color:#0c5460; padding:15px; border-radius:5px; margin-bottom:15px; border:1px solid #bee5eb;">
        <strong>✅ 提出可能</strong><br>
        期限内です。希望シフトを入力してください。
      </div>
    {% endif %}
    
    {% if notice %}
    <div style="background:#e2e3e5; padding:15px; margin-bottom:20px; border-radius:8px;">
      <strong>店舗からのお知らせ:</strong> {{ notice }}
    </div>
    {% endif %}
    
    <div id="shift-settings" 
         data-min-hours="{{ min_hours }}"
         data-start-limit="{{ start_limit }}"
         data-end-limit="{{ end_limit }}">
    </div>

    <form method="POST" class="form-card" onsubmit="return validateForm()">
      <input type="hidden" name="date" value="{{ date }}">

      <div class="form-group">
        <label>ID</label>
        <input type="text" name="name" value="{{ session.get('user_id', '') }}" readonly>
      </div>

      <div class="form-group">
        <label>出勤有無</label>
        <!-- ★修正：期限外+確定済みの場合のみ無効化 -->
        <select id="workSelect" name="work" onchange="toggleTimeInputs()" {% if is_locked and is_late %}disabled{% endif %}>
          <option value="1" {% if current_data and current_data.type == '1' %}selected{% endif %}>○ 出勤可能</option>
          <option value="0" {% if current_data and current_data.type == '0' %}selected{% endif %}>× 出勤不可</option>
        </select>
      </div>

      <div class="form-group">
        <label>開始時間</label>
        <!-- ★修正：期限外+確定済みの場合のみ無効化 -->
        <input type="time" id="startTime" name="start_time" 
               min="{{ start_limit }}" max="{{ end_limit }}" 
               value="{{ current_data.start_time if current_data else '' }}"
               {% if is_locked and is_late %}disabled{% endif %} required>
               
        <small style="color:#666; font-size:0.85em; display:block; margin-top:5px;">営業時間: {{ start_limit }} 〜 {{ end_limit }}</small>
      </div>

      <div class="form-group">
        <label>終了時間</label>
        <!-- ★修正：期限外+確定済みの場合のみ無効化 -->
        <input type="time" id="endTime" name="end_time" 
               min="{{ start_limit }}" max="{{ end_limit }}" 
               value="{{ current_data.end_time if current_data else '' }}"
               {% if is_locked and is_late %}disabled{% endif %} required>
               
        <small style="color:#666; font-size:0.85em; display:block; margin-top:5px;">最低勤務時間: {{ min_hours }} 時間</small>
      </div>

      <!-- ★修正：期限外+確定済みの場合のみボタンを無効化 -->
      {% if is_locked and is_late %}
        <button type="button" class="btn" style="background-color: #ccc; cursor: not-allowed;" disabled>変更不可</button>
      {% else %}
        <button type="submit" class="btn">保存</button>
      {% endif %}
      
    </form>

    <a href="{{ url_for('calendar.calendar') }}" class="back-link">← カレンダーに戻る</a>
  </div>

  <script src="{{ url_for('static', filename='js/shinsei.js') }}"></script>
</body>
</html>