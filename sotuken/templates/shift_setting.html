<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚·ãƒ•ãƒˆè‡ªå‹•ç”Ÿæˆè¨­å®š</title>
  
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 0; }
    
    .menu-btn { position: fixed; top: 20px; left: 20px; z-index: 1001; cursor: pointer; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; }
    .menu-btn span { display: block; width: 30px; height: 3px; background-color: #fff; margin: 6px 0; }
    
    .side-menu { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background-color: #333; transition: 0.3s; z-index: 1000; padding-top: 80px; }
    .side-menu.active { left: 0; }
    .side-menu ul { list-style: none; padding: 0; }
    .side-menu li a { display: block; padding: 15px 20px; color: #fff; text-decoration: none; border-bottom: 1px solid #444; }
    
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 80px; }

    .flash-message { padding: 15px; border-radius: 5px; margin-bottom: 10px; color: #fff; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .flash-success { background-color: #4caf50; }
    .flash-danger  { background-color: #f44336; }
    .flash-info    { background-color: #2196f3; }
    .flash-warning { background-color: #ff9800; }

    /* åŸºæœ¬è¨­å®šã‚¨ãƒªã‚¢ */
    .basic-settings-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      color: white;
    }
    .basic-settings-card h2 {
      margin: 0 0 20px 0;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .setting-item {
      background: rgba(255,255,255,0.15);
      padding: 15px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    .setting-item label {
      display: block;
      font-size: 0.85em;
      margin-bottom: 8px;
      opacity: 0.9;
      font-weight: 500;
    }
    .setting-item input {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s;
    }
    .setting-item input:focus {
      outline: none;
      border-color: white;
      background: white;
    }
    .save-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .time-zone-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .zone-card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #ccc; }
    .zone-morning { border-color: #4caf50; }
    .zone-lunch   { border-color: #ff9800; }
    .zone-idle    { border-color: #9e9e9e; }
    .zone-night   { border-color: #3f51b5; }

    .zone-title { font-weight: bold; font-size: 1.2em; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .form-row { margin-bottom: 10px; }
    .form-row label { display: block; font-size: 0.9em; color: #666; margin-bottom: 3px; }
    .form-row input, .form-row select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    .add-btn { width: 100%; border: none; padding: 10px; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 10px; }
    
    .demand-list { background: #fff; padding: 20px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { background: #f9f9f9; color: #555; }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const menuBtn = document.getElementById('menuBtn');
      const sideMenu = document.getElementById('sideMenu');
      if(menuBtn){
          menuBtn.onclick = () => sideMenu.classList.toggle('active');
          document.addEventListener('click', (e) => {
              if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                  sideMenu.classList.remove('active');
              }
          });
      }

      // æ™‚é–“å¸¯æœ€å¤§äººæ•°ã®åˆ¶é™ã‚’å„ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
      const maxPeopleInput = document.querySelector('input[name="max_people_per_shift"]');
      const demandForms = document.querySelectorAll('.zone-card form');
      
      function getMaxPeople() {
        return parseInt(maxPeopleInput.value) || 30;
      }

      // å„éœ€è¦è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      demandForms.forEach(form => {
        const countInput = form.querySelector('input[name="required_count"]');
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯
        countInput.addEventListener('input', function() {
          const maxPeople = getMaxPeople();
          const currentValue = parseInt(this.value);
          
          if (currentValue > maxPeople) {
            this.style.borderColor = '#f44336';
            this.style.backgroundColor = '#ffebee';
            showWarning(this, `âš ï¸ æ™‚é–“å¸¯æœ€å¤§äººæ•°(${maxPeople}å)ã‚’è¶…ãˆã¦ã„ã¾ã™`);
          } else {
            this.style.borderColor = '#ddd';
            this.style.backgroundColor = 'white';
            hideWarning(this);
          }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒã‚§ãƒƒã‚¯
        form.addEventListener('submit', function(e) {
          const maxPeople = getMaxPeople();
          const currentValue = parseInt(countInput.value);
          
          if (currentValue > maxPeople) {
            e.preventDefault();
            alert(`âŒ è¨­å®šã§ãã¾ã›ã‚“\n\næ™‚é–“å¸¯æœ€å¤§äººæ•°ã¯ ${maxPeople} åã§ã™ã€‚\nç¾åœ¨ã®å…¥åŠ›: ${currentValue} å\n\nåŸºæœ¬è¨­å®šã§æœ€å¤§äººæ•°ã‚’å¢—ã‚„ã™ã‹ã€å¿…è¦äººæ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
            countInput.focus();
            return false;
          }
        });
      });

      // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      function showWarning(input, message) {
        let warning = input.parentElement.querySelector('.warning-message');
        if (!warning) {
          warning = document.createElement('div');
          warning.className = 'warning-message';
          warning.style.cssText = 'color: #f44336; font-size: 0.85em; margin-top: 5px; font-weight: bold;';
          input.parentElement.appendChild(warning);
        }
        warning.textContent = message;
      }

      // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
      function hideWarning(input) {
        const warning = input.parentElement.querySelector('.warning-message');
        if (warning) {
          warning.remove();
        }
      }

      // æœ€å¤§äººæ•°ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å…¨ã¦ã®å…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯
      maxPeopleInput.addEventListener('input', function() {
        demandForms.forEach(form => {
          const countInput = form.querySelector('input[name="required_count"]');
          countInput.dispatchEvent(new Event('input'));
        });
      });
    });
  </script>
</head>
<body>

  <div class="menu-btn" id="menuBtn"><span></span><span></span><span></span></div>
  
  <nav class="side-menu" id="sideMenu">
    <ul>
      <li><a href="{{ url_for('calendar.admin') }}">å¸Œæœ›ä¸€è¦§</a></li>
      <li><a href="{{ url_for('shift.manage_faq') }}">å±¥æ­´</a></li> 
      <li><a href="{{ url_for('makeshift.settings') }}">è¨­å®š</a></li>
      <li><a href="{{ url_for('insert.insert') }}">å¾“æ¥­å“¡ç™»éŒ²</a></li>
      <li><a href="{{ url_for('makeshift.generate_shift') }}">ã‚·ãƒ•ãƒˆä½œæˆ</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>ğŸ›  ã‚·ãƒ•ãƒˆè‡ªå‹•ç”Ÿæˆè¨­å®š</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-bottom: 20px;">
          {% for category, msg in messages %}
            <div class="flash-message flash-{{ category }}">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- åŸºæœ¬è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="basic-settings-card">
      <h2>âš™ï¸ åŸºæœ¬è¨­å®š</h2>
      <form method="POST" action="{{ url_for('makeshift.settings') }}">
        <div class="settings-grid">
          <div class="setting-item">
            <label>ğŸ• é–‹å§‹æ™‚é–“</label>
            <input type="time" name="start_time" value="{{ settings.start_time }}" min="00:00" max="23:59" required>
          </div>
          <div class="setting-item">
            <label>ğŸ•™ çµ‚äº†æ™‚é–“</label>
            <input type="time" name="end_time" value="{{ settings.end_time }}" min="00:00" max="23:59" required>
          </div>
          <div class="setting-item">
            <label>ğŸ‘¥ æ™‚é–“å¸¯æœ€å¤§äººæ•° <span style="font-size:0.8em; opacity:0.8;">(é‡è¦)</span></label>
            <input type="number" name="max_people_per_shift" value="{{ settings.max_people_per_shift }}" min="1" max="100" required>
            <small style="display:block; margin-top:5px; font-size:0.75em; opacity:0.8;">ä¸‹è¨˜ã®å¿…è¦äººæ•°è¨­å®šã®ä¸Šé™å€¤</small>
          </div>
          <div class="setting-item">
            <label>â±ï¸ æ™‚é–“é–“éš”ï¼ˆåˆ†ï¼‰</label>
            <input type="number" name="interval_minutes" value="{{ settings.interval_minutes }}" min="5" max="60" step="5" required>
          </div>
          <div class="setting-item">
            <label>ğŸ“… 1æ—¥æœ€å¤§å‹¤å‹™æ™‚é–“</label>
            <input type="number" name="max_hours_per_day" value="{{ settings.max_hours_per_day }}" min="1" max="24" step="0.5" required>
          </div>
          <div class="setting-item">
            <label>â˜• ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
            <input type="number" name="break_minutes" value="{{ settings.break_minutes }}" min="0" max="120" step="15" required>
          </div>
        </div>
        <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã¨ã™ã‚‹å€¤ -->
        <input type="hidden" name="min_hours_per_day" value="{{ settings.min_hours_per_day }}">
        <input type="hidden" name="auto_mode" value="{{ settings.auto_mode }}">
        
        <div style="text-align: right;">
          <button type="submit" class="save-btn">ğŸ’¾ åŸºæœ¬è¨­å®šã‚’ä¿å­˜</button>
        </div>
      </form>
    </div>

    <h2 style="margin-top: 40px;">ğŸ“Š å¿™ã—ã•ãƒ»å¿…è¦äººæ•°è¨­å®š</h2>
    <p style="color:#666; margin-bottom:20px;">æ™‚é–“å¸¯ã”ã¨ã«å¿…è¦ãªäººæ•°ã‚’å…¥åŠ›ã—ã¦ã€Œè¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>â€»å„ã‚¨ãƒªã‚¢ã®æ™‚é–“ã¯è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ã€‚</p>

    <div class="time-zone-grid">

      <div class="zone-card zone-morning">
        <div class="zone-title">â˜€ï¸ æœãƒ»é–‹åº—æº–å‚™</div>
        <form action="{{ url_for('makeshift.add_demand') }}" method="POST">
          <div style="display:flex; gap:10px;">
            <div class="form-row" style="flex:1;">
              <label>é–‹å§‹</label>
              <input type="time" name="start_time" value="09:00">
            </div>
            <div class="form-row" style="flex:1;">
              <label>çµ‚äº†</label>
              <input type="time" name="end_time" value="11:00">
            </div>
          </div>
          <div class="form-row">
            <label>å½¹å‰²</label>
            <select name="position_id">
                {% for pos in positions %}
                  <option value="{{ pos.id }}" {% if pos.id == 2 %}selected{% endif %}>{{ pos.name }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="form-row">
            <label>äººæ•°</label>
            <input type="number" name="required_count" min="0" value="1">
          </div>
          <button type="submit" class="add-btn" style="background:#4caf50;">ï¼‹ æœã®è¨­å®šã‚’è¿½åŠ </button>
        </form>
      </div>

      <div class="zone-card zone-lunch">
        <div class="zone-title">ğŸ” æ˜¼ãƒ»ãƒ©ãƒ³ãƒãƒ”ãƒ¼ã‚¯</div>
        <form action="{{ url_for('makeshift.add_demand') }}" method="POST">
          <div style="display:flex; gap:10px;">
            <div class="form-row" style="flex:1;">
              <label>é–‹å§‹</label>
              <input type="time" name="start_time" value="11:30">
            </div>
            <div class="form-row" style="flex:1;">
              <label>çµ‚äº†</label>
              <input type="time" name="end_time" value="14:00">
            </div>
          </div>
          <div class="form-row">
            <label>å½¹å‰²</label>
            <select name="position_id">
                {% for pos in positions %}
                  <option value="{{ pos.id }}">{{ pos.name }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="form-row">
            <label>äººæ•°</label>
            <input type="number" name="required_count" min="0" value="3">
          </div>
          <button type="submit" class="add-btn" style="background:#ff9800;">ï¼‹ æ˜¼ã®è¨­å®šã‚’è¿½åŠ </button>
        </form>
      </div>

      <div class="zone-card zone-idle">
        <div class="zone-title">â˜•ï¸ 15æ™‚ãƒ»ã‚¢ã‚¤ãƒ‰ãƒ«</div>
        <form action="{{ url_for('makeshift.add_demand') }}" method="POST">
          <div style="display:flex; gap:10px;">
            <div class="form-row" style="flex:1;">
              <label>é–‹å§‹</label>
              <input type="time" name="start_time" value="15:00">
            </div>
            <div class="form-row" style="flex:1;">
              <label>çµ‚äº†</label>
              <input type="time" name="end_time" value="17:00">
            </div>
          </div>
          <div class="form-row">
            <label>å½¹å‰²</label>
            <select name="position_id">
                {% for pos in positions %}
                  <option value="{{ pos.id }}">{{ pos.name }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="form-row">
            <label>äººæ•°</label>
            <input type="number" name="required_count" min="0" value="1">
          </div>
          <button type="submit" class="add-btn" style="background:#9e9e9e;">ï¼‹ ä¼‘æ†©æ™‚é–“ã®è¨­å®šã‚’è¿½åŠ </button>
        </form>
      </div>

      <div class="zone-card zone-night">
        <div class="zone-title">ğŸ» å¤œãƒ»ãƒ‡ã‚£ãƒŠãƒ¼</div>
        <form action="{{ url_for('makeshift.add_demand') }}" method="POST">
          <div style="display:flex; gap:10px;">
            <div class="form-row" style="flex:1;">
              <label>é–‹å§‹</label>
              <input type="time" name="start_time" value="18:00">
            </div>
            <div class="form-row" style="flex:1;">
              <label>çµ‚äº†</label>
              <input type="time" name="end_time" value="22:00">
            </div>
          </div>
          <div class="form-row">
            <label>å½¹å‰²</label>
            <select name="position_id">
                {% for pos in positions %}
                  <option value="{{ pos.id }}">{{ pos.name }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="form-row">
            <label>äººæ•°</label>
            <input type="number" name="required_count" min="0" value="4">
          </div>
          <button type="submit" class="add-btn" style="background:#3f51b5;">ï¼‹ å¤œã®è¨­å®šã‚’è¿½åŠ </button>
        </form>
      </div>

    </div>

    <div class="demand-list">
      <h3>ğŸ“Š ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è¨­å®šä¸€è¦§</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th style="width: 100px;">æ™‚é–“å¸¯</th>
              <th>å½¹å‰²</th>
              <th style="width: 100px;">å¿…è¦äººæ•°</th>
              <th style="width: 80px; text-align: center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for d in demands %}
            <tr>
              <td>{{ d.time_slot }}</td>
              <td>
                {% if 'ã‚­ãƒƒãƒãƒ³' in d.position_name %}
                  <span style="color:#d32f2f; font-weight:bold;">ğŸ³ {{ d.position_name }}</span>
                {% elif 'ãƒ›ãƒ¼ãƒ«' in d.position_name %}
                  <span style="color:#1976d2; font-weight:bold;">ğŸ›ï¸ {{ d.position_name }}</span>
                {% else %}
                  {{ d.position_name }}
                {% endif %}
              </td>
              <td><b>{{ d.required_count }}</b> å</td>
              <td style="text-align: center;">
                <form action="{{ url_for('makeshift.delete_demand') }}" method="POST" style="display:inline; margin:0;">
                  <input type="hidden" name="time_slot" value="{{ d.time_slot }}">
                  <input type="hidden" name="position_id" value="{{ d.position_id }}">
                  <button type="submit" style="background:#ff5252; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; font-size:0.85em;" onclick="return confirm('ã“ã®è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">å‰Šé™¤</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="4" style="text-align:center; color:#aaa;">è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
        <span style="color:#666; font-size:0.9em;">åˆè¨ˆ {{ demands|length }} ä»¶ã®è¨­å®š</span>
        <form action="{{ url_for('makeshift.reset_demand') }}" method="POST" style="margin:0;">
          <button type="submit" class="btn" style="background:#d32f2f; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;" onclick="return confirm('å…¨ã¦ã®è¨­å®šã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')">ğŸ—‘ å…¨ã¦å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        </form>
      </div>
    </div>

  </div>
</body>
</html>