<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ˜ãƒ«ãƒ—å‹Ÿé›†ã¸ã®å¿œå‹Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .status-closed { color: red; font-weight: bold; }
        .loading-overlay { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255, 255, 255, 0.8); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 10;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card p-4 position-relative">
                <h3 class="text-center mb-4">ğŸš¨ ãƒ˜ãƒ«ãƒ—å‹Ÿé›†</h3>

                <div id="message-area" class="alert d-none text-center" role="alert"></div>

                <div class="mb-3">
                    <label class="form-label text-muted">æ—¥ä»˜</label>
                    <h5 class="fw-bold">{{ req.date }}</h5> 
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted">é–‹å§‹æ™‚åˆ»</label>
                    <p class="lead">{{ req.start_time }}</p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted">çµ‚äº†æ™‚åˆ»</label>
                    <p class="lead">{{ req.end_time }}</p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted">å‹Ÿé›†ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                    <p>{{ req.position_id }}</p>
                </div>

                <hr>

                {% if req.status == 'open' %}
                <div class="d-grid gap-2">
                    <button id="applyBtn" class="btn btn-primary btn-lg" onclick="applyForShift()">
                        ã“ã®ã‚·ãƒ•ãƒˆã«å…¥ã‚‹ï¼ (æ—©ã„è€…å‹ã¡)
                    </button>
                </div>
                
                {% else %}
                <div class="d-grid gap-2 text-center text-danger fw-bold">
                    <p>ã“ã®å‹Ÿé›†ã¯ã™ã§ã«ç· ã‚åˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    <button class="btn btn-secondary btn-lg" disabled>
                        å‹Ÿé›†ã¯çµ‚äº†ã—ã¾ã—ãŸ
                    </button>
                </div>
                {% endif %}

                <div id="loading-overlay" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    async function applyForShift() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨ (æœ¬æ¥ã¯LINE IDãªã©ã‹ã‚‰ç‰¹å®šã™ã‚‹)
        const staffId = '{{ staff_id_for_form }}'; 
        const requestId = '{{ req.id }}'; 

        if (!staffId || staffId === '') {
            alert("ã‚¹ã‚¿ãƒƒãƒ•IDãŒç‰¹å®šã§ãã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const btn = document.getElementById('applyBtn');
        const messageArea = document.getElementById('message-area');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // å¿œå‹Ÿå‡¦ç†é–‹å§‹
        btn.disabled = true;
        btn.innerText = "åˆ¤å®šä¸­...";
        messageArea.classList.add('d-none');
        loadingOverlay.style.display = 'flex'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

        try {
            const response = await fetch('/api/help/accept', { // ğŸ‘ˆ URLã‚’ /api/help/accept ã«ä¿®æ­£
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    request_id: requestId,
                    user_id: staffId // ğŸ‘ˆ ã‚­ãƒ¼ã‚’ 'user_id' ã«ä¿®æ­£
                })
            });

            const result = await response.json();

            loadingOverlay.style.display = 'none'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            messageArea.classList.remove('d-none');
            
            if (response.ok && result.status === 'success') {
                // æˆåŠŸ
                messageArea.classList.remove('alert-danger', 'alert-warning');
                messageArea.classList.add('alert-success');
                messageArea.innerHTML = "ğŸ‰ **ã‚·ãƒ•ãƒˆãŒç¢ºå®šã—ã¾ã—ãŸï¼**<br>" + result.message;
                // å¿œå‹ŸæˆåŠŸã®ãŸã‚ã€ãƒœã‚¿ãƒ³ã‚’å®Œå…¨ã«éæ´»æ€§åŒ–
                btn.innerText = "å¿œå‹Ÿå®Œäº†";
                // ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã¨ã‚¯ãƒ­ãƒ¼ã‚ºçŠ¶æ…‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                setTimeout(() => { location.reload(); }, 1000);

            } else {
                // å¤±æ•— (ã‚¿ãƒƒãƒã®å·®ã§åŸ‹ã¾ã£ãŸå ´åˆãªã©)
                messageArea.classList.remove('alert-success', 'alert-warning');
                messageArea.classList.add('alert-danger');
                messageArea.innerHTML = "ğŸ˜¢ **å¿œå‹Ÿå¤±æ•—**<br>" + result.message;
                // å¤±æ•—ã—ãŸå ´åˆã‚‚ã€å‹Ÿé›†ãŒã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æ›´æ–°
                setTimeout(() => { location.reload(); }, 1000); 
            }

        } catch (error) {
            console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            loadingOverlay.style.display = 'none';
            messageArea.classList.remove('d-none', 'alert-success', 'alert-danger');
            messageArea.classList.add('alert-warning');
            messageArea.innerHTML = "âŒ **ã‚¨ãƒ©ãƒ¼**<br>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚";
            
            btn.disabled = false;
            btn.innerText = "ã“ã®ã‚·ãƒ•ãƒˆã«å…¥ã‚‹ï¼";
        }
    }
</script>

</body>
</html>