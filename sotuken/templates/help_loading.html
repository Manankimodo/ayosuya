<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ˜ãƒ«ãƒ—å‹Ÿé›†ã¸ã®å¿œå‹Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* 1. å…¨ä½“è¨­å®š */
        body {
            padding-top: 40px; 
            background-color: #f0f2f5; /* èƒŒæ™¯è‰²ã‚’è¿½åŠ  */
        }
        
        /* 2. ã‚«ãƒ¼ãƒ‰ï¼ˆç™½ã„æ ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* å½±ã‚’ã¤ã‘ã¦æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
            border-radius: 15px; 
            border: none; 
        }

        /* 3. ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ˜ãƒ«ãƒ—å‹Ÿé›†ï¼‰ */
        .card h3 {
            font-weight: 800; 
            color: #0d6efd; 
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #0d6efd; /* é’ã„ä¸‹ç·š */
            margin-bottom: 1.5rem;
            display: inline-block; 
        }

        /* 4. ãƒ©ãƒ™ãƒ«ï¼ˆæ—¥ä»˜ã€é–‹å§‹æ™‚åˆ»ãªã©ï¼‰ */
        .form-label.text-muted {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d !important; 
            text-transform: uppercase; 
            border-left: 4px solid #dee2e6; /* å·¦ã«ç°è‰²ã®ç·š */
            padding-left: 10px;
            margin-bottom: 5px;
        }

        /* 5. é‡è¦ãªå€¤ï¼ˆæ™‚é–“ãªã©ï¼‰ã®å¼·èª¿ */
        .lead {
            font-size: 1.5rem; 
            font-weight: 700;
            color: #212529; 
            background-color: #e9ecef; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
            padding: 5px 15px;
            border-radius: 8px;
            display: inline-block;
        }

        /* æ—¥ä»˜éƒ¨åˆ†ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        h5.fw-bold {
            font-size: 1.2rem;
            margin-left: 5px;
        }

        /* 6. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
        .loading-overlay { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9); 
            border-radius: 15px; 
            /* Flexboxã‚’ä½¿ã£ã¦ä¸­å¤®æƒãˆã«ã™ã‚‹ãŒã€åˆæœŸçŠ¶æ…‹ã¯ d-none (éè¡¨ç¤º) ã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ */
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã¨ãç”¨ã®ã‚¯ãƒ©ã‚¹ */
        .loading-overlay.active {
            display: flex;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* 7. ãƒœã‚¿ãƒ³ */
        .btn-lg {
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5"> <div class="card p-4 position-relative">
                
                <div class="text-center">
                    <h3 class="mb-4">ğŸš¨ ãƒ˜ãƒ«ãƒ—å‹Ÿé›†</h3>
                </div>

                <div id="message-area" class="alert d-none text-center" role="alert"></div>

                <div class="mb-4">
                    <label class="form-label text-muted">æ—¥ä»˜</label>
                    <h5 class="fw-bold">{{ req.date }}</h5> 
                </div>

                <div class="row">
                    <div class="col-6">
                        <div class="mb-4">
                            <label class="form-label text-muted">é–‹å§‹</label>
                            <p class="lead">{{ req.start_time }}</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="mb-4">
                            <label class="form-label text-muted">çµ‚äº†</label>
                            <p class="lead">{{ req.end_time }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label text-muted">å‹Ÿé›†ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                    <p class="fs-5 ms-2">{{ req.position_id }}</p>
                </div>

                <hr class="my-4">

                {% if req.status == 'open' %}
                <div class="d-grid gap-2">
                    <button id="applyBtn" class="btn btn-primary btn-lg" onclick="applyForShift()">
                        ã“ã®ã‚·ãƒ•ãƒˆã«å…¥ã‚‹ï¼
                    </button>
                    <small class="text-center text-muted">â€»æ—©ã„è€…å‹ã¡ã§ã™</small>
                </div>
                
                {% else %}
                <div class="d-grid gap-2 text-center">
                    <div class="alert alert-danger fw-bold">
                        å‹Ÿé›†ã¯çµ‚äº†ã—ã¾ã—ãŸ
                    </div>
                    <button class="btn btn-secondary btn-lg" disabled>
                        å—ä»˜çµ‚äº†
                    </button>
                </div>
                {% endif %}

                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    async function applyForShift() {
        const staffId = '{{ staff_id_for_form }}'; 
        const requestId = '{{ req.id }}'; 

        if (!staffId) {
            alert("ã‚¨ãƒ©ãƒ¼: ã‚¹ã‚¿ãƒƒãƒ•IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        const btn = document.getElementById('applyBtn');
        const messageArea = document.getElementById('message-area');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // å¿œå‹Ÿå‡¦ç†é–‹å§‹
        btn.disabled = true;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º (ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦CSSã‚’é©ç”¨)
        loadingOverlay.style.display = 'flex'; // å¼·åˆ¶çš„ã«è¡¨ç¤º
        loadingOverlay.classList.add('active');

        try {
            const response = await fetch('/line/api/help/accept', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: requestId,
                    user_id: staffId 
                })
            });

            const result = await response.json();

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
            loadingOverlay.style.display = 'none';
            loadingOverlay.classList.remove('active');
            
            if (response.ok && result.status === 'success') {
                messageArea.classList.remove('d-none', 'alert-danger', 'alert-warning');
                messageArea.classList.add('alert-success');
                messageArea.innerHTML = "ğŸ‰ **ã‚·ãƒ•ãƒˆãŒç¢ºå®šã—ã¾ã—ãŸï¼**";
                btn.innerText = "å¿œå‹Ÿå®Œäº†";
                setTimeout(() => { location.reload(); }, 1500); 
            } else {
                messageArea.classList.remove('d-none');
                messageArea.classList.add('alert-danger');
                messageArea.innerText = result.message || "å¿œå‹Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                setTimeout(() => { location.reload(); }, 2000); 
            }

        } catch (error) {
            console.error(error);
            loadingOverlay.style.display = 'none';
            messageArea.classList.remove('d-none');
            messageArea.classList.add('alert-warning');
            messageArea.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>