<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">
    <title>AI チャットボット</title>
</head>
<body>
    <!-- ハンバーガー -->
    <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
    </div>

    <!-- メニュー -->
    <nav class="menu" id="menu">
        <ul>
            <li><a href="{{ url_for('calendar.calendar') }}">カレンダー</a></li>
        </ul>
    </nav>

    <h1>アルバイト教育支援チャットボット</h1>

    <!-- 💬 チャットエリア -->
    <div class="chat-container" id="chat-container">
        {% if chat_history %}
            {% for msg in chat_history %}
                <div class="message {{ 'user' if msg.role == 'user' else 'bot' }}">{{ msg.text }}</div>
            {% endfor %}
        {% else %}
            <div class="message bot">こんにちは！ご質問をどうぞ 😊</div>
        {% endif %}
    </div>

    <!-- ✏️ 入力欄 -->
    <form id="chat-form" method="POST" action="/chatbot/">
        <input type="text" id="question" name="question" placeholder="質問を入力..." required>
        <button type="submit">送信</button>
    </form>

    <script>
        // 🍔 メニュー開閉
        document.getElementById('hamburger').addEventListener('click', () => {
            document.getElementById('hamburger').classList.toggle('active');
            document.getElementById('menu').classList.toggle('active');
        });

        // 💬 チャット送信処理（非同期送信）
        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("question");
            const userText = input.value.trim();
            if (!userText) return;

            const chatContainer = document.getElementById("chat-container");

            // ユーザーメッセージを追加
            const userMsg = document.createElement("div");
            userMsg.className = "message user";
            userMsg.textContent = userText;
            chatContainer.appendChild(userMsg);
            input.value = "";
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // サーバーへ送信
            const response = await fetch("/chatbot/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ question: userText })
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // 新しい履歴を取得して全体置き換え
            const newChat = doc.querySelector("#chat-container").innerHTML;
            chatContainer.innerHTML = newChat;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    </script>
</body>
</html>
