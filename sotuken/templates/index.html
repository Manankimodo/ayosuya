<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">
    <title>AI ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
</head>
<body>
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ -->
    <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <nav class="menu" id="menu">
        <ul>
            <li><a href="{{ url_for('calendar.calendar') }}">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a></li>
        </ul>
    </nav>

    <h1>ã‚¢ãƒ«ãƒã‚¤ãƒˆæ•™è‚²æ”¯æ´ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>

    <!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-container" id="chat-container">
        {% if chat_history %}
            {% for msg in chat_history %}
                <div class="message {{ 'user' if msg.role == 'user' else 'bot' }}">
                    {{ msg.text }}
                    {% if msg.role == 'bot' and loop.previtem and loop.previtem.role == 'user' %}
                        <!-- ğŸ”„ å†ç”Ÿæˆãƒœã‚¿ãƒ³ -->
                        <button class="regen-btn" data-question="{{ loop.previtem.text }}">ğŸ”„å†ç”Ÿæˆ</button>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="message bot">ã“ã‚“ã«ã¡ã¯ï¼ã”è³ªå•ã‚’ã©ã†ã ğŸ˜Š</div>
        {% endif %}
    </div>

    <!-- âœï¸ å…¥åŠ›æ¬„ -->
    <form id="chat-form" method="POST" action="/chatbot/">
        <input type="text" id="question" name="question" placeholder="è³ªå•ã‚’å…¥åŠ›..." required>
        <button type="submit">é€ä¿¡</button>
        <button type="button" id="clear-btn">å±¥æ­´ã‚’æ¶ˆã™</button>
    </form>

    <script>
        // ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        document.getElementById('hamburger').addEventListener('click', () => {
            document.getElementById('hamburger').classList.toggle('active');
            document.getElementById('menu').classList.toggle('active');
        });

        // ğŸ’¬ ãƒãƒ£ãƒƒãƒˆé€ä¿¡å‡¦ç†ï¼ˆéåŒæœŸé€ä¿¡ï¼‰
        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("question");
            const userText = input.value.trim();
            if (!userText) return;

            const chatContainer = document.getElementById("chat-container");

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            const userMsg = document.createElement("div");
            userMsg.className = "message user";
            userMsg.textContent = userText;
            chatContainer.appendChild(userMsg);
            input.value = "";
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
            const response = await fetch("/chatbot/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ question: userText })
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // æ–°ã—ã„å±¥æ­´ã‚’å–å¾—ã—ã¦å…¨ä½“ç½®ãæ›ãˆ
            const newChat = doc.querySelector("#chat-container").innerHTML;
            chatContainer.innerHTML = newChat;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // ğŸ—‘ å±¥æ­´å‰Šé™¤ãƒœã‚¿ãƒ³
        document.getElementById("clear-btn").addEventListener("click", async () => {
            if (!confirm("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æœ¬å½“ã«æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;

            await fetch("/chatbot/clear", { method: "POST" });

            const chatContainer = document.getElementById("chat-container");
            chatContainer.innerHTML = '<div class="message bot">ã“ã‚“ã«ã¡ã¯ï¼ã”è³ªå•ã‚’ã©ã†ã ğŸ˜Š</div>';
        });

        // ğŸ”„ å†ç”Ÿæˆãƒœã‚¿ãƒ³æ©Ÿèƒ½ï¼ˆAjaxï¼‰
        document.addEventListener("click", async (e) => {
            if (e.target.classList.contains("regen-btn")) {
                const btn = e.target;
                const question = btn.dataset.question;
                const botMessage = btn.closest(".message");

                btn.disabled = true;
                btn.textContent = "å†ç”Ÿæˆä¸­...";

                try {
                    const res = await fetch("/chatbot/regenerate", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ question })
                    });

                    const data = await res.json();
                    botMessage.childNodes[0].textContent = data.answer;
                } catch {
                    alert("å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                } finally {
                    btn.disabled = false;
                    btn.textContent = "ğŸ”„å†ç”Ÿæˆ";
                }
            }
        });
    </script>
</body>
</html>
