<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">
    <title>AI ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
</head>
<body>
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ -->
    <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <nav class="menu" id="menu">
        <ul>
            <li><a href="{{ url_for('calendar.calendar') }}">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a></li>
        </ul>
    </nav>

    <h1>ã‚¢ãƒ«ãƒã‚¤ãƒˆæ•™è‚²æ”¯æ´ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>

    <!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-container" id="chat-container">
        {% if chat_history %}
            {% for msg in chat_history %}
                <div class="message {{ 'user' if msg.role == 'user' else 'bot' }}">{{ msg.text }}</div>
            {% endfor %}
        {% else %}
            <div class="message bot">ã“ã‚“ã«ã¡ã¯ï¼ã”è³ªå•ã‚’ã©ã†ã ğŸ˜Š</div>
        {% endif %}
    </div>

    <!-- âœï¸ å…¥åŠ›æ¬„ -->
    <form id="chat-form" method="POST" action="/chatbot/">
        <input type="text" id="question" name="question" placeholder="è³ªå•ã‚’å…¥åŠ›..." required>
        <button type="submit">é€ä¿¡</button>
    </form>

    <script>
        // ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        document.getElementById('hamburger').addEventListener('click', () => {
            document.getElementById('hamburger').classList.toggle('active');
            document.getElementById('menu').classList.toggle('active');
        });

        // ğŸ’¬ ãƒãƒ£ãƒƒãƒˆé€ä¿¡å‡¦ç†ï¼ˆéåŒæœŸé€ä¿¡ï¼‰
        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("question");
            const userText = input.value.trim();
            if (!userText) return;

            const chatContainer = document.getElementById("chat-container");

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            const userMsg = document.createElement("div");
            userMsg.className = "message user";
            userMsg.textContent = userText;
            chatContainer.appendChild(userMsg);
            input.value = "";
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
            const response = await fetch("/chatbot/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ question: userText })
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // æ–°ã—ã„å±¥æ­´ã‚’å–å¾—ã—ã¦å…¨ä½“ç½®ãæ›ãˆ
            const newChat = doc.querySelector("#chat-container").innerHTML;
            chatContainer.innerHTML = newChat;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    </script>
</body>
</html>
